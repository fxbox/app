define(["components/react","components/react-dom"],function(e,t){"use strict";e="default"in e?e["default"]:e,t="default"in t?t["default"]:t;var n=function(){var e="function"==typeof Symbol&&Symbol["for"]&&Symbol["for"]("react.element")||60103;return function(t,n,i,o){var r=t&&t.defaultProps,s=arguments.length-3;if(n||0===s||(n={}),n&&r)for(var a in r)void 0===n[a]&&(n[a]=r[a]);else n||(n=r||{});if(1===s)n.children=o;else if(s>1){for(var c=Array(s),l=0;s>l;l++)c[l]=arguments[l+3];n.children=c}return{$$typeof:e,type:t,key:void 0===i?null:""+i,ref:null,props:n,_owner:null}}}(),i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},o=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),r=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},s=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},a=function(){function e(e,t){var n=[],i=!0,o=!1,r=void 0;try{for(var s,a=e[Symbol.iterator]();!(i=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);i=!0);}catch(c){o=!0,r=c}finally{try{!i&&a["return"]&&a["return"]()}finally{if(o)throw r}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),c=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},l=function(){function e(t){i(this,e),Object.assign(this,t||{})}return e.prototype.main=function(){throw new Error("Not implemented!")},e}(),u=function(e){function t(n){i(this,t);var o=s(this,e.call(this,n));return o.foxbox=n.foxbox,o}return r(t,e),t.prototype.shouldComponentUpdate=function(){return!1},t.prototype.handleOnClick=function(){this.foxbox.logout()},t.prototype.render=function(){var e=location.hash.substr(1).split("/").shift(),t=[{id:"services",label:"Home"},{id:"themes",label:"Themes"},{id:"mr-fox",label:"Mr. Fox"}].map(function(t){var i="navigation-menu__item";return e===t.id&&(i+=" navigation-menu__item--active"),n("li",{className:i},t.id,n("a",{href:`#${t.id}`,className:"navigation-menu__item-link"},void 0,t.label))});return n("ul",{className:"navigation-menu"},void 0,t,n("li",{className:"navigation-menu__item"},void 0,n("a",{href:"#users/login",className:"navigation-menu__item-link user-logout-button",onClick:this.handleOnClick.bind(this)},void 0,"Log out")))},t}(e.Component),h=function(e){function t(){return i(this,t),s(this,e.apply(this,arguments))}return r(t,e),t.prototype.renderHeader=function(e,t){var i="app-view__header";return t&&(i+=` ${t}`),n("header",{className:i},void 0,n("h1",{},void 0,e))},t.prototype.renderFooter=function(){return n("footer",{className:"app-view__footer"},void 0,n(u,{foxbox:this.props.foxbox}))},t.prototype.renderBody=function(){return null},t.prototype.render=function(){return n("div",{className:"app-view"},void 0,this.renderHeader(),n("section",{className:"app-view__body"},void 0,this.renderBody()),this.renderFooter())},t}(e.Component),d=function(e){function t(n){i(this,t);var o=s(this,e.call(this,n));return o.state={boxes:n.foxbox.boxes,selectedBox:null,loginEnabled:n.foxbox.online},o.foxbox=n.foxbox,o.onBoxOnline=o.onBoxOnline.bind(o),o.onBoxDiscovery=o.onBoxDiscovery.bind(o),o.onSelectChange=o.onSelectChange.bind(o),o.onFormSubmit=o.onFormSubmit.bind(o),o}return r(t,e),t.prototype.componentDidMount=function(){this.foxbox.on("online",this.onBoxOnline),this.foxbox.on("discovery",this.onBoxDiscovery)},t.prototype.componentWillUnmount=function(){this.foxbox.off("online",this.onBoxOnline),this.foxbox.off("discovery",this.onBoxDiscovery)},t.prototype.onSelectChange=function(e){var t=e.target.selectedIndex;this.setState({selectedBox:t}),this.foxbox.selectBox(t)},t.prototype.onFormSubmit=function(e){e.preventDefault(),this.foxbox.login()},t.prototype.onBoxOnline=function(e){this.setState({loginEnabled:e})},t.prototype.onBoxDiscovery=function(){this.setState({boxes:this.foxbox.boxes})},t.prototype.renderHeader=function(){return e.prototype.renderHeader.call(this,"Project Link","app-view__header--white")},t.prototype.renderFooter=function(){return null},t.prototype.renderBody=function(){var e=this,t=null;if(this.state.boxes.length>1){var i=this.state.selectedBox||0,o=this.state.boxes.map(function(t,o){return t.client===e.foxbox.client&&(i=o),n("option",{value:o},t.client,t.client)});t=n("select",{className:"user-login__box-selector",value:i,onChange:this.onSelectChange},void 0,o)}return n("form",{className:"app-view__fill-body user-login",onSubmit:this.onFormSubmit},void 0,n("img",{className:"user-login__logo",src:"img/icon.svg"}),t,n("button",{className:"user-login__login-button",disabled:!this.state.loginEnabled},void 0,"Connect to your box"))},t}(h),p=["login","logout"],f=p[0],v=function(n){function o(){return i(this,o),s(this,n.apply(this,arguments))}return r(o,n),o.prototype.main=function(){var e=arguments.length<=0||void 0===arguments[0]?f:arguments[0];switch(p.includes(e)||(console.error(`Bad users route: "${e}". Falling back to ${f}.`),e=f),e){case"login":this.login();break;case"logout":this.logout()}},o.prototype.login=function(){t.render(e.createElement(d,{foxbox:this.foxbox}),this.mountNode)},o.prototype.logout=function(){this.foxbox.logout(),location.hash="#users/login"},o}(l),g=function(e){function t(n){i(this,t);var o=s(this,e.call(this,n));return o.state={available:!1,on:!0,locked:!0,motionDetected:!1},o.service=n.service,o.foxbox=n.foxbox,o.onMotion=o.onMotion.bind(o),o}return r(t,e),t.prototype.componentDidMount=function(){var e=this;switch(this.service.type){case"light":this.service.isAvailable().then(function(t){e.setState({available:t})})["catch"](console.error.bind(console)),this.service.isOn().then(function(t){e.setState({on:t})})["catch"](console.error.bind(console));break;case"motion-sensor":this.service.isMotionDetected().then(this.onMotion),this.service.watch("motion",this.onMotion);break;case"door-lock":this.service.isLocked().then(function(t){e.setState({locked:t})})["catch"](function(e){console.error("Can not retrieve door lock status: %o",e)})}},t.prototype.componentWillUnmount=function(){switch(this.service.type){case"motion-sensor":this.service.unwatch("motion",this.onMotion)}},t.prototype.handleLightOnChange=function(e){var t=this,n=e.target.checked;this.setState({on:n}),this.service.turn(n)["catch"](function(e){t.setState({on:!n}),console.error(e)})},t.prototype.onDoorLockUnlock=function(e){var t=this,n=e.target.checked;this.setState({locked:n}),this.service.lockUnlock(n)["catch"](function(e){t.setState({locked:!n}),console.error("Could not change door lock status: %o",e)})},t.prototype.onMotion=function(e){this.setState({motionDetected:e})},t.prototype.getBulbColour=function(){var e=1,t=1,n=1,i=e,o=Math.round(100*t),r=n;return`hsla(${i},${o}%,50%,${r})`},t.prototype.renderLightService=function(){var e=this.state.available,t="Light",i="light";if(void 0!==this.service.model)switch(this.service.model){case"BSB002":i="bridge_v2";break;case"LCT001":case"LCT007":case"LCT010":case"LTW010":case"LWB004":case"LWB006":i="white_and_color_e27_b22";break;case"LWB010":case"LWB014":i="white_e27_b22";break;case"LCT002":case"LCT011":case"LTW011":case"LWB005":case"LWB011":i="br30";break;case"LCT003":i="gu10_par16";break;case"LST001":case"LST002":i="lightstrip";break;case"LLC006":case"LLC010":i="iris";break;case"LLC005":case"LLC011":case"LLC012":case"LLC007":i="bloom";break;case"LLC014":i="aura";break;case"LLC013":i="storylight";break;case"LLC020":i="go";break;case"HBL001":case"HBL002":case"HBL003":i="beyond_ceiling_pendant_table";break;case"HIL001":case"HIL002":i="impulse";break;case"HEL001":case"HEL002":i="entity";break;case"HML001":case"HML002":case"HML003":case"HML004":case"HML005":case"HML006":i="phoenix_ceiling_pendant_table_wall";break;case"HML007":i="phoenix_recessed_spot";break;case"SWT001":i="tap";break;case"RWL021":i="hds"}var o=this.getServiceName(),r=o?n("small",{},void 0,` (${o})`):null;return n("li",{className:"service-list__item","data-icon":i,"data-connected":e},void 0,n("a",{className:"service-list__item-link",href:`#services/${this.service.id}`},void 0,t,r),n("div",{className:"service-list__item-color-picker",style:{background:this.getBulbColour()}},void 0),n("label",{},void 0,n("input",{className:"service-list__on-off-toggle",type:"checkbox",checked:this.state.on,disabled:!e,onChange:this.handleLightOnChange.bind(this)})))},t.prototype.renderDoorLock=function(){var e=this.getServiceName(),t=e?n("small",{},void 0,` (${e})`):null;return n("li",{className:"service-list__item","data-icon":"door-lock"},void 0,n("a",{className:"service-list__item-link",href:`#services/${this.service.id}`},void 0,"Door Lock",t),n("label",{},void 0,n("input",{className:"service-list__on-off-toggle",type:"checkbox",checked:this.state.locked,onChange:this.onDoorLockUnlock.bind(this)})))},t.prototype.renderMotionSensor=function(){var e=this.getServiceName(),t=e?n("small",{},void 0,` (${e})`):null,i="service-list__item motion-sensor-item";return this.state.motionDetected&&(i+=" motion-sensor-item--motion-detected"),n("li",{className:i},void 0,n("a",{className:"service-list__item-link",href:`#services/${this.service.id}`},void 0,"Motion Sensor",t))},t.prototype.renderGenericService=function(){var e=arguments.length<=0||void 0===arguments[0]?"Unknown service":arguments[0],t=arguments.length<=1||void 0===arguments[1]?"unknown":arguments[1],i=this.getServiceName(),o=i?n("small",{},void 0,` (${i})`):null;return n("li",{className:"service-list__item","data-icon":t,"data-connected":"true"},void 0,n("a",{className:"service-list__item-link",href:`#services/${this.service.id}`},void 0,e,o))},t.prototype.render=function(){switch(this.service.type){case"door-lock":return this.renderDoorLock();case"ip-camera":return this.renderGenericService("Camera","ip-camera");case"light":return this.renderLightService();case"motion-sensor":return this.renderMotionSensor();default:return this.renderGenericService()}},t.prototype.getServiceName=function(){return this.service.getTags().join(", ")||this.service.name},t}(e.Component),m=function(e){function t(){return i(this,t),s(this,e.apply(this,arguments))}return r(t,e),t.prototype.render=function(){var e=this,t=this.props.services.filter(function(e){return"unknown"!==e.type}),i=t.map(function(t){return n(g,{service:t,foxbox:e.props.foxbox},t.id)});return n("ul",{className:"service-list"},void 0,i)},t}(e.Component),b=function(e){function t(n){i(this,t);var o=s(this,e.call(this,n));return o.state={services:[],title:"",body:""},o.foxbox=n.foxbox,o.updateServiceList=o.updateServiceList.bind(o),o.updateServiceState=o.updateServiceState.bind(o),o}return r(t,e),t.prototype.componentDidMount=function(){this.updateServiceList(),this.foxbox.services.togglePolling(!0),this.foxbox.services.on("services-changed",this.updateServiceList),this.foxbox.services.on("service-changed",this.updateServiceState)},t.prototype.componentWillUnmount=function(){this.foxbox.services.togglePolling(!1),this.foxbox.services.off("services-changed",this.updateServiceList),this.foxbox.services.off("service-changed",this.updateServiceState)},t.prototype.updateServiceList=function(){var e=this;this.foxbox.services.getAll().then(function(t){return e.setState({services:t})})["catch"](function(e){console.error("Could not update service list: %o",e)})},t.prototype.updateServiceState=function(e){var t=this.state.services.findIndex(function(t){return t.id===e.id}),n=this.state.services;n[t]=e,this.setState({services:n})},t.prototype.renderHeader=function(){return e.prototype.renderHeader.call(this,"My Home")},t.prototype.renderBody=function(){return n("div",{className:"app-view__fill-body"},void 0,n("h2",{},void 0,"General"),n(m,{services:this.state.services,foxbox:this.foxbox}))},t}(h),y=function(n){function o(){return i(this,o),s(this,n.apply(this,arguments))}return r(o,n),o.prototype.main=function(){t.render(e.createElement(b,{foxbox:this.foxbox}),this.mountNode)},o}(l),S=function(t){function o(e){i(this,o);var n=s(this,t.call(this,e));return n.state={hasPreview:!1,hasPreviousSnapshot:!1},n.foxbox=e.foxbox,n.service=e.service,n}return r(o,t),o.prototype.takeSnapshot=function(){var e=this;this.service.takeSnapshot().then(function(t){var n=e.refs.snapshotPreview.src,i={hasPreview:!0,hasPreviousSnapshot:!1};e.refs.snapshotPreview.src=URL.createObjectURL(t),n&&(i.hasPreviousSnapshot=!0,e.refs.previousSnapshot.src&&URL.revokeObjectURL(e.refs.previousSnapshot.src),e.refs.previousSnapshot.src=n),e.setState(i)})["catch"](function(e){console.error("Error occurred while making a snapshot: ",e)})},o.prototype.render=function(){var t="app-view__fill-body camera-controls";return this.state.hasPreview&&(t+=" camera-controls--has-preview"),this.state.hasPreviousSnapshot&&(t+=" camera-controls--has-previous-snapshot"),n("div",{className:t},void 0,e.createElement("img",{ref:"snapshotPreview",alt:"Snapshot preview",className:"camera-controls__preview"}),n("div",{className:"camera-controls__empty-preview"},void 0,n("p",{},void 0,"Preview is not available."),n("p",{},void 0,"Touch button to take a snapshot!")),n("section",{className:"camera-controls__snapshot-tools"},void 0,n("button",{className:"camera-controls__snapshot-btn",type:"button",title:"Take a snapshot",onClick:this.takeSnapshot.bind(this)},void 0),e.createElement("img",{ref:"previousSnapshot",className:"camera-controls__previous-snapshot"})))},o}(e.Component),w=function(e){function t(n){i(this,t);var o=s(this,e.call(this,n));return o.state={name:n.service.name},o.foxbox=n.foxbox,o.service=n.service,o.onServiceStateChanged=o.onServiceStateChanged.bind(o),o}return r(t,e),t.prototype.componentDidMount=function(){this.foxbox.services.on("service-changed",this.onServiceStateChanged)},t.prototype.componentWillUnmount=function(){this.foxbox.services.off("service-changed",this.onServiceStateChanged)},t.prototype.onServiceStateChanged=function(e){e.id===this.service.id&&(this.service=e,this.setState({name:e.name}))},t.prototype.render=function(){return n("div",{className:"app-view__fill-body default-service__body"},void 0,n("p",{className:"default-service__notice"},void 0,"Oops, there are no settings available for this service."))},t}(e.Component),k=function(e){function t(n){i(this,t);var o=s(this,e.call(this,n));return o.state={name:n.service.name},o.foxbox=n.foxbox,o.service=n.service,o.onServiceStateChanged=o.onServiceStateChanged.bind(o),o}return r(t,e),t.prototype.componentDidMount=function(){this.foxbox.services.on("service-changed",this.onServiceStateChanged)},t.prototype.componentWillUnmount=function(){this.foxbox.services.off("service-changed",this.onServiceStateChanged)},t.prototype.onServiceStateChanged=function(e){e.id===this.service.id&&(this.service=e,this.setState({name:e.name}))},t.prototype.render=function(){return n("div",{className:"app-view__fill-body default-service__body"},void 0,n("p",{className:"default-service__notice"},void 0,"Oops, there are no settings available for this service."))},t}(e.Component),x=function(e){function t(n){i(this,t);var o=s(this,e.call(this,n));return o.state={service:null},o.foxbox=n.foxbox,o}return r(t,e),t.prototype.componentDidMount=function(){var e=this;this.foxbox.services.get(this.props.id).then(function(t){e.setState({service:t})})["catch"](function(e){console.error("Error occurred while retrieving service: ",e)})},t.prototype.renderHeader=function(){if(!this.state.service)return e.prototype.renderHeader.call(this,"Unknown Service");var t=this.state.service.name?this.state.service.name:"Unknown Service";return n("header",{className:"app-view__header"},void 0,n("h1",{},void 0,t),n("a",{href:`#services/${this.state.service.id}/tags`,title:"Edit tags",className:"service__edit-tags-link"},void 0,n("img",{className:"app-view__action-icon",src:"css/icons/tag.svg",alt:"Edit tags"})))},t.prototype.renderBody=function(){if(!this.state.service)return null;switch(this.state.service.type){case"ip-camera":return n(S,{service:this.state.service,foxbox:this.foxbox});case"light":return n(w,{service:this.state.service,foxbox:this.foxbox});default:return n(k,{service:this.state.service,foxbox:this.foxbox})}},t}(h);x.propTypes={foxbox:e.PropTypes.object.isRequired,id:e.PropTypes.string.isRequired};var _=function(n){function o(){return i(this,o),s(this,n.apply(this,arguments))}return r(o,n),o.prototype.main=function(n){t.render(e.createElement(x,{id:n,foxbox:this.foxbox}),this.mountNode)},o}(l),L=function(e){function t(){return i(this,t),s(this,e.apply(this,arguments))}return r(t,e),t.prototype.render=function(){var e=this,t=this.props.tags.map(function(t){return n("li",{className:"tag-list__item"},t,t,n("button",{className:"tag-list__item-remove",type:"button",onClick:e.props.onRemoveTag.bind(null,t),title:"Remove tag"}))});return n("ul",{className:"tag-list"},void 0,t)},t}(e.Component),O=function(e){function t(n){i(this,t);var o=s(this,e.call(this,n));return o.state={service:null,tags:[]},o.foxbox=n.foxbox,o.onServiceStateChanged=o.onServiceStateChanged.bind(o),o}return r(t,e),t.prototype.componentDidMount=function(){var e=this;this.foxbox.services.get(this.props.id).then(function(t){e.setState({service:t,tags:t.getTags()})})["catch"](function(e){console.error("Error occurred while retrieving service: ",e)}),this.foxbox.services.on("service-changed",this.onServiceStateChanged)},t.prototype.componentWillUnmount=function(){this.foxbox.services.off("service-changed",this.onServiceStateChanged)},t.prototype.onServiceStateChanged=function(e){e.id===this.props.id&&this.setState({service:e,tags:e.getTags()})},t.prototype.onAddTag=function(){var e=this,t=this.state.service;if(t){var n=(prompt("Enter new tag name")||"").trim();n&&(t.addTag(n)["catch"](function(i){console.error(`Could not add the tag "${n}": %o`,i),e.setState({tags:t.getTags()})}),this.setState({tags:t.getTags()}))}},t.prototype.onRemoveTag=function(e){var t=this,n=this.state.service;n.removeTag(e)["catch"](function(i){console.error(`Could not remove the tag "${e}": %o`,i),t.setState({tags:n.getTags()})}),this.setState({tags:n.getTags()})},t.prototype.renderHeader=function(){var t=this.state.service;return e.prototype.renderHeader.call(this,t&&t.name?t.name:"Unknown Service")},t.prototype.renderBody=function(){return n("div",{className:"app-view__fill-body"},void 0,n("h2",{},void 0,"Tags"),n(L,{tags:this.state.tags,onRemoveTag:this.onRemoveTag.bind(this)}),n("button",{className:"add-tag-button",type:"button",onClick:this.onAddTag.bind(this)},void 0,"Create a new tag"))},t}(h);O.propTypes={foxbox:e.PropTypes.object.isRequired,id:e.PropTypes.string.isRequired};var C=function(n){function o(){return i(this,o),s(this,n.apply(this,arguments))}return r(o,n),o.prototype.main=function(n){t.render(e.createElement(O,{id:n,foxbox:this.foxbox}),this.mountNode)},o}(l),N=function(e){function t(n){i(this,t);var o=s(this,e.call(this,n));return o.state={enabled:n.theme.enabled},o.foxbox=n.foxbox,o.handleOnChange=o.handleOnChange.bind(o),o.handleOnDelete=o.handleOnDelete.bind(o),o}return r(t,e),t.prototype.handleOnChange=function(e){var t=this,n=e.target.checked;this.setState({enabled:n}),this.foxbox.recipes.toggle(this.props.theme,n)["catch"](function(e){t.setState({enabled:!n}),console.error(e)})},t.prototype.handleOnDelete=function(){var e=this;this.foxbox.recipes.remove(this.props.theme).then(function(){e.props.update()})["catch"](console.error.bind(console))},t.prototype.render=function(){var e="themes-list__item";return this.state.enabled||(e+=" themes-list__item--deactivated"),n("li",{className:e},void 0,n("input",{className:"themes-list__toggle",type:"checkbox",checked:this.state.enabled,onChange:this.handleOnChange}),n("span",{className:"themes-list__name"},void 0,this.props.theme.label),n("button",{className:"themes-list__remove",onClick:this.handleOnDelete}))},t}(e.Component),E=function(e){function t(n){i(this,t);var o=s(this,e.call(this,n));return o.state={themes:[]},o.foxbox=n.foxbox,o.update=o.update.bind(o),o}return r(t,e),t.prototype.componentDidMount=function(){this.update()},t.prototype.update=function(){var e=this;this.foxbox.recipes.getAll().then(function(t){e.setState({themes:t})})["catch"](console.error.bind(console))},t.prototype.renderHeader=function(){return n("header",{className:"app-view__header"},void 0,n("h1",{},void 0,"Recipes"),n("a",{href:"#themes/new",className:"themes__new-link"},void 0,n("img",{className:"app-view__action-icon",src:"css/icons/plus.svg",alt:"Add a recipe"})))},t.prototype.renderBody=function(){var e=this,t=this.state.themes.map(function(t){return n(N,{theme:t,update:e.update,foxbox:e.foxbox},t.id)});return n("div",{className:"app-view__fill-body themes"},void 0,n("ul",{className:"themes-list"},void 0,t))},t}(h),I=function(e){function t(n){i(this,t);var o=s(this,e.call(this,n));return o.state={getters:[],setters:[],selectedGetterIndex:-1,selectedGetterValueIndex:-1,selectedSetterIndex:-1,selectedSetterValueIndex:-1},o.foxbox=n.foxbox,o.updateServices=o.updateServices.bind(o),o.onGetterSelected=o.onGetterSelected.bind(o),o.onGetterValueSelected=o.onGetterValueSelected.bind(o),o.onSetterSelected=o.onSetterSelected.bind(o),o.onSetterValueSelected=o.onSetterValueSelected.bind(o),o.onSaveRecipe=o.onSaveRecipe.bind(o),o}return r(t,e),t.prototype.componentDidMount=function(){var e=this;Promise.all([this.foxbox.recipes.getGetters(),this.foxbox.recipes.getSetters()]).then(function(t){return e.updateServices(t)})["catch"](console.error.bind(console))},t.prototype.updateServices=function(){var e=arguments.length<=0||void 0===arguments[0]?[[],[]]:arguments[0],t=a(e,2),n=t[0],i=t[1];this.setState({getters:n,setters:i})},t.prototype.onGetterSelected=function(e){var t=-1;e.target.value&&(t=Number(e.target.value)),this.setState({selectedGetterIndex:t,selectedGetterValueIndex:-1,selectedSetterIndex:-1,selectedSetterValueIndex:-1})},t.prototype.onGetterValueSelected=function(e){var t=-1;e.target.value&&(t=Number(e.target.value)),this.setState({selectedGetterValueIndex:t,selectedSetterIndex:-1,selectedSetterValueIndex:-1})},t.prototype.onSetterSelected=function(e){var t=-1;e.target.value&&(t=Number(e.target.value)),this.setState({selectedSetterIndex:t,selectedSetterValueIndex:-1})},t.prototype.onSetterValueSelected=function(e){var t=-1;e.target.value&&(t=Number(e.target.value)),this.setState({selectedSetterValueIndex:t})},t.prototype.onSaveRecipe=function(){if(!(this.state.selectedSetterValueIndex<0)){var e=this.state.getters[this.state.selectedGetterIndex],t=e.options[this.state.selectedGetterValueIndex],n=this.state.setters[this.state.selectedSetterIndex],i=n.options[this.state.selectedSetterValueIndex],o=`${e.name} ${t.label}, `+`${n.name} ${i.label}.`;this.foxbox.recipes.add({name:o,getter:e,getterValue:t,setter:n,setterValue:i}).then(function(){location.hash="#themes"})["catch"](function(e){console.log("Error occurred while saving recipe: ",e)})}},t.prototype.renderHeader=function(){var e="app-view__action";return null===this.state.setter&&(e+=" app-view__action--disabled"),n("header",{className:"app-view__header"},void 0,n("a",{href:"#themes",className:"app-view__action"},void 0,"Cancel"),n("h1",{},void 0,"New Recipe"),n("button",{className:e,onClick:this.onSaveRecipe},void 0,"Done"))},t.prototype.renderBody=function(){var e="new-theme__header";return this.state.selectedGetterValueIndex<0&&(e+=" new-theme__header--hidden"),n("div",{className:"app-view__fill-body new-theme"},void 0,n("h2",{className:"new-theme__header"},void 0,"If"),this.renderGetterSelector(),this.renderGetterValueSelector(),n("h2",{className:e},void 0,"Do"),this.renderSetterSelector(),this.renderSetterValueSelector())},t.prototype.renderGetterSelector=function(){var e=this,t="new-theme__select";this.state.selectedGetterIndex>=0&&(t+=" new-theme__select--selected");var i=this.state.getters.map(function(t,i){return n("option",{value:i},i,e.getChannelName(t))});return n("select",{value:this.state.selectedGetterIndex,onChange:this.onGetterSelected,className:t},void 0,n("option",{value:""},void 0,"Select a device"),i)},t.prototype.renderGetterValueSelector=function(){if(this.state.selectedGetterIndex<0)return n("select",{className:"new-theme__select new-theme__select--hidden"},void 0);var e="new-theme__select";this.state.selectedGetterValueIndex>=0&&(e+=" new-theme__select--selected");var t=this.state.getters[this.state.selectedGetterIndex].options,i=t.map(function(e,t){return n("option",{value:t},t,e.label)});return n("select",{value:this.state.selectedGetterValueIndex,onChange:this.onGetterValueSelected,className:e},void 0,n("option",{value:""},void 0,"Select a property"),i)},t.prototype.renderSetterSelector=function(){var e=this;if(this.state.selectedGetterValueIndex<0)return n("select",{className:"new-theme__select new-theme__select--hidden"},void 0);var t="new-theme__select";this.state.selectedSetterIndex>=0&&(t+=" new-theme__select--selected");var i=this.state.setters.map(function(t,i){return n("option",{value:i},i,e.getChannelName(t))});return n("select",{value:this.state.selectedSetterIndex,onChange:this.onSetterSelected,className:t},void 0,n("option",{value:""},void 0,"Select a device"),i)},t.prototype.renderSetterValueSelector=function(){if(this.state.selectedSetterIndex<0)return n("select",{className:"new-theme__select new-theme__select--hidden"},void 0);var e="new-theme__select";null!==this.state.setter&&(e+=" new-theme__select--selected");var t=this.state.setters[this.state.selectedSetterIndex].options,i=t.map(function(e,t){return n("option",{value:t},t,e.label)});return n("select",{value:this.state.selectedSetterValueIndex,onChange:this.onSetterValueSelected,className:e},void 0,n("option",{value:""},void 0,"Select a property"),i)},t.prototype.getChannelName=function(e){var t=e.tags.join(", ");return t?`${e.name} (${t})`:e.name},t}(h),T=function(n){function o(){return i(this,o),s(this,n.apply(this,arguments))}return r(o,n),o.prototype.main=function(){var n=arguments.length<=0||void 0===arguments[0]?"list":arguments[0],i={foxbox:this.foxbox};switch(n){case"list":t.render(e.createElement(E,i),this.mountNode);break;case"new":t.render(e.createElement(I,i),this.mountNode)}},o}(l),P=function(t){function o(e){i(this,o);var n=s(this,t.call(this,e));return n.state={service:null,hasPreview:!1},n.foxbox=e.foxbox,n}return r(o,t),o.prototype.componentDidMount=function(){var e=this;this.foxbox.services.get(this.props.id).then(function(t){return e.setState({service:t}),t.getLatestImage()}).then(function(t){e.refs.snapshotPreview.src=URL.createObjectURL(t),e.setState({hasPreview:!0})})["catch"](function(t){console.error("Error occurred while retrieving latest image for camera (id=%s): ",e.props.id,t)})},o.prototype.renderHeader=function(){return t.prototype.renderHeader.call(this,this.state.service&&this.state.service.name?this.state.service.name:"Unknown Service")},o.prototype.renderBody=function(){var t="app-view__fill-body camera-controls";return this.state.hasPreview&&(t+=" camera-controls--has-preview"),n("div",{className:t},void 0,e.createElement("img",{ref:"snapshotPreview",style:{flexGrow:0},alt:"Snapshot preview",className:"camera-controls__preview"}),n("div",{className:"camera-controls__empty-preview"},void 0,n("p",{},void 0,"Preview is being loaded."),n("p",{},void 0,"Wait a moment please!")))},o}(h);P.propTypes={foxbox:e.PropTypes.object.isRequired,id:e.PropTypes.string.isRequired};var j=function(n){function o(){return i(this,o),s(this,n.apply(this,arguments))}return r(o,n),o.prototype.main=function(n,i){switch(n){case"camera-latest-image":t.render(e.createElement(P,{id:i,foxbox:this.foxbox}),this.mountNode);break;default:console.error('Unknown development view path "%s"',n)}},o}(l),V=function(e){if(!e||"string"!=typeof e)throw new Error("Event name should be a valid non-empty string!")},R=function(e){if("function"!=typeof e)throw new Error("Handler should be a function!")},D=function(e,t){if(e&&e.indexOf(t)<0)throw new Error(`Event "${t}" is not allowed!`)},A=Object.freeze({allowedEvents:Symbol("allowedEvents"),listeners:Symbol("listeners")}),U=function(){function e(t){if(i(this,e),"undefined"!=typeof t&&!Array.isArray(t))throw new Error("Allowed events should be a valid array of strings!");this[A.listeners]=new Map,this[A.allowedEvents]=t}return e.prototype.on=function(e,t){V(e),D(this[A.allowedEvents],e),R(t);var n=this[A.listeners].get(e);n||(n=new Set,this[A.listeners].set(e,n)),n.add(t)},e.prototype.once=function t(e,n){var i=this;R(n);var t=function(o){i.off(e,t),n.call(i,o)};this.on(e,t)},e.prototype.off=function(e,t){V(e),D(this[A.allowedEvents],e),R(t);var n=this[A.listeners].get(e);n&&(n["delete"](t),n.size||this[A.listeners]["delete"](e))},e.prototype.offAll=function(e){if("undefined"==typeof e)return void this[A.listeners].clear();V(e),D(this[A.allowedEvents],e);var t=this[A.listeners].get(e);t&&(t.clear(),this[A.listeners]["delete"](e))},e.prototype.emit=function(e,t){var n=this;V(e),D(this[A.allowedEvents],e);var i=this[A.listeners].get(e);i&&i.forEach(function(e){try{e.call(n,t)}catch(i){console.error(i)}})},e.prototype.hasListeners=function(e){return V(e),D(this[A.allowedEvents],e),this[A.listeners].has(e)},e}(),G="foxbox-",H=1,B="auth",z=/([A-Z])/g,M=Object.freeze({values:Symbol("values"),storage:Symbol("storage"),updateSetting:Symbol("updateSetting"),stringToSettingTypedValue:Symbol("stringToSettingTypedValue"),getDefaultSettingValue:Symbol("getDefaultSettingValue"),onStorage:Symbol("onStorage")}),F=Object.freeze({CONFIGURED:Object.freeze({key:"configured",type:"boolean"}),SKIP_DISCOVERY:Object.freeze({key:"skipDiscovery",type:"boolean"}),SERVICE_POLLING_ENABLED:Object.freeze({key:"servicePollingEnabled",type:"boolean",defaultValue:!0}),SERVICE_POLLING_INTERVAL:Object.freeze({key:"servicePollingInterval",type:"number",defaultValue:2e3}),WATCH_INTERVAL:Object.freeze({key:"watchInterval",type:"number",defaultValue:3e3}),ONLINE_CHECKING_INTERVAL:Object.freeze({key:"onlineCheckingInterval",type:"number",defaultValue:5e3}),ONLINE_CHECKING_LONG_INTERVAL:Object.freeze({key:"onlineCheckingLongInterval",type:"number",defaultValue:3e5}),LOCAL_ORIGIN:Object.freeze({key:"localOrigin"}),TUNNEL_ORIGIN:Object.freeze({key:"tunnelOrigin"}),CLIENT:Object.freeze({key:"client"}),SESSION:Object.freeze({key:"session"}),PUSH_ENDPOINT:Object.freeze({key:"pushEndpoint"}),PUSH_PUB_KEY:Object.freeze({key:"pushPubKey"}),PUSH_AUTH:Object.freeze({key:"pushAuth"}),REGISTRATION_SERVICE:Object.freeze({key:"registrationService",defaultValue:"https://knilxof.org:4443/ping"})}),W=function(e){function t(){var n=arguments.length<=0||void 0===arguments[0]?localStorage:arguments[0];i(this,t);var o=s(this,e.call(this));return o[M.storage]=n||{getItem:function(){return null},setItem:function(){},removeItem:function(){},clear:function(){}},o[M.values]=new Map,Object.keys(F).forEach(function(e){var t=F[e],n=o[M.storage].getItem(`${G}${t.key}`);o[M.values].set(t,o[M.stringToSettingTypedValue](t,n))}),window.addEventListener("storage",o[M.onStorage].bind(o)),Object.seal(o),o}return r(t,e),t.prototype.clear=function(){var e=this;return new Promise(function(t){Object.keys(F).forEach(function(t){var n=F[t];e[M.updateSetting](n,e[M.getDefaultSettingValue](n))}),t()})},t.prototype[M.updateSetting]=function(e,t){var n=this[M.values].get(e);n!==t&&(this[M.values].set(e,t),t!==this[M.getDefaultSettingValue](e)?this[M.storage].setItem(`${G}${e.key}`,t):this[M.storage].removeItem(`${G}${e.key}`),
this.emit(e.key.replace(z,function(e){return`-${e.toLowerCase()}`}),t))},t.prototype[M.stringToSettingTypedValue]=function(e,t){return null===t?this[M.getDefaultSettingValue](e):"boolean"===e.type?"true"===t:"number"===e.type?Number(t):t},t.prototype[M.getDefaultSettingValue]=function(e){return void 0!==e.defaultValue?e.defaultValue:"boolean"!==e.type&&("number"===e.type?0:null)},t.prototype[M.onStorage]=function(e){if(e.key.startsWith(G)){var t=e.key.substring(G.length),n=Object.keys(F).find(function(e){return F[e].key===t});if(!n)return void console.warn(`Changed unknown storage entry with app specific prefix: ${e.key}`);var i=F[n];this[M.updateSetting](i,this[M.stringToSettingTypedValue](i,e.newValue))}},o(t,[{key:"configured",get:function(){return this[M.values].get(F.CONFIGURED)},set:function(e){this[M.updateSetting](F.CONFIGURED,e)}},{key:"localOrigin",get:function(){return this[M.values].get(F.LOCAL_ORIGIN)},set:function(e){this[M.updateSetting](F.LOCAL_ORIGIN,e?new URL(e).origin:null)}},{key:"tunnelOrigin",get:function(){return this[M.values].get(F.TUNNEL_ORIGIN)},set:function(e){this[M.updateSetting](F.TUNNEL_ORIGIN,e?new URL(e).origin:null)}},{key:"client",get:function(){return this[M.values].get(F.CLIENT)},set:function(e){this[M.updateSetting](F.CLIENT,e?String(e):null)}},{key:"session",get:function(){return this[M.values].get(F.SESSION)},set:function(e){this[M.updateSetting](F.SESSION,e)}},{key:"skipDiscovery",get:function(){return this[M.values].get(F.SKIP_DISCOVERY)},set:function(e){this[M.updateSetting](F.SKIP_DISCOVERY,e)}},{key:"servicePollingEnabled",get:function(){return this[M.values].get(F.SERVICE_POLLING_ENABLED)},set:function(e){this[M.updateSetting](F.SERVICE_POLLING_ENABLED,e)}},{key:"pushEndpoint",get:function(){return this[M.values].get(F.PUSH_ENDPOINT)},set:function(e){this[M.updateSetting](F.PUSH_ENDPOINT,e)}},{key:"pushPubKey",get:function(){return this[M.values].get(F.PUSH_PUB_KEY)},set:function(e){this[M.updateSetting](F.PUSH_PUB_KEY,e)}},{key:"pushAuth",get:function(){return this[M.values].get(F.PUSH_AUTH)},set:function(e){this[M.updateSetting](F.PUSH_AUTH,e)}},{key:"registrationService",get:function(){return this[M.values].get(F.REGISTRATION_SERVICE)}},{key:"servicePollingInterval",get:function(){return this[M.values].get(F.SERVICE_POLLING_INTERVAL)}},{key:"onlineCheckingInterval",get:function(){return this[M.values].get(F.ONLINE_CHECKING_INTERVAL)}},{key:"onlineCheckingLongInterval",get:function(){return this[M.values].get(F.ONLINE_CHECKING_LONG_INTERVAL)}},{key:"watchInterval",get:function(){return this[M.values].get(F.WATCH_INTERVAL)}},{key:"queryStringAuthTokenName",get:function(){return B}},{key:"apiVersion",get:function(){return H}}]),t}(U),K=Object.freeze({promise:Symbol("promise"),resolve:Symbol("resolve"),reject:Symbol("reject")}),q=function(){function e(){var t=this;i(this,e),this[K.promise]=new Promise(function(e,n){t[K.resolve]=e,t[K.reject]=n}),Object.freeze(this)}return e.prototype.resolve=function(e){this[K.resolve](e)},e.prototype.reject=function(e){this[K.reject](e)},o(e,[{key:"promise",get:function(){return this[K.promise]}}]),e}(),J=Object.freeze({db:Symbol("db"),initializationStarted:Symbol("initializationStarted"),upgradeSchema:Symbol("upgradeSchema"),getAll:Symbol("getAll"),getById:Symbol("getById"),set:Symbol("set"),remove:Symbol("remove"),clearDb:Symbol("clearDb")}),Y="foxbox-db",$=1,Z="services",Q=function(){function e(){i(this,e),this[J.db]=new q,this[J.initializationStarted]=!1,Object.seal(this)}return e.prototype.init=function(){var e=this,t=this[J.db].promise.then(function(){});if(this[J.initializationStarted])return t;try{var n=indexedDB.open(Y,$);n.onupgradeneeded=this[J.upgradeSchema],n.onsuccess=function(t){return e[J.db].resolve(t.target.result)},n.onerror=function(t){return e[J.db].reject(t)}}catch(i){this[J.db].reject(i)}return t["catch"](function(e){throw console.error("Error opening database: %o",e),e})},e.prototype.clear=function(){var e=this;return this[J.db].promise.then(function(e){return e.close(),new Promise(function(e,t){var n=indexedDB.deleteDatabase(Y);n.onsuccess=e,n.onerror=t,n.onblocked=t})}).then(function(){e[J.db]=new q,e[J.initializationStarted]=!1})},e.prototype.getServices=function(){return this[J.getAll](Z)},e.prototype.getService=function(e){return this[J.getById](Z,e)},e.prototype.setService=function(e){return this[J.set](Z,e)},e.prototype.deleteService=function(e){return this[J.remove](Z,e.id)},e.prototype.clearServices=function(){return this[J.clearDb](Z)},e.prototype[J.upgradeSchema]=function(e){var t=e.target.result,n=e.oldVersion;if(1>n){var i=t.createObjectStore(Z,{keyPath:"id"});i.createIndex("id","id",{unique:!0})}},e.prototype[J.getAll]=function(e){return this[J.db].promise.then(function(t){return new Promise(function(n,i){var o=t.transaction([e],"readonly"),r=[];o.onerror=i,o.oncomplete=function(){return n(r)},o.objectStore(e).openCursor().onsuccess=function(e){var t=e.target.result;t&&(r.push(t.value),t["continue"]())}})})},e.prototype[J.getById]=function(e,t){return this[J.db].promise.then(function(n){return new Promise(function(i,o){var r=n.transaction([e],"readonly");r.onerror=o,r.objectStore(e).get(t).onsuccess=function(e){i(e.target.result)}})})},e.prototype[J.set]=function(e,t){return this[J.db].promise.then(function(n){return new Promise(function(i,o){var r=n.transaction([e],"readwrite");r.oncomplete=i,r.onerror=o;try{r.objectStore(e).put(t)}catch(s){console.error(`Error putting data in ${Y}:`,s),i()}})})},e.prototype[J.remove]=function(e,t){return this[J.db].promise.then(function(n){return new Promise(function(i,o){var r=n.transaction([e],"readwrite");r.oncomplete=i,r.onerror=o;try{r.objectStore(e)["delete"](t)}catch(s){console.error(`Error deleting data from ${Y}:`,s),i()}})})},e.prototype[J.clearDb]=function(e){return this[J.db].promise.then(function(t){return new Promise(function(n,i){var o=t.transaction([e],"readwrite");o.oncomplete=n,o.onerror=i,o.objectStore(e).clear()})})},e}(),X=Object.freeze({started:Symbol("started"),nextTickHandle:Symbol("nextTickHandle"),scheduleTick:Symbol("scheduleTick"),onTick:Symbol("onTick")}),ee=function(){function e(t){i(this,e),this.interval=t,this[X.started]=!1,this[X.nextTickHandle]=null,this[X.onTick]=null,Object.seal(this)}return e.prototype.start=function(e){if(this[X.started])return void console.warn("Timer has been already started.");if("function"!=typeof e)throw new Error("onTick handler should be a valid function.");this[X.started]=!0,this[X.onTick]=e,this[X.scheduleTick]()},e.prototype.stop=function(){return this[X.started]?(this[X.started]=!1,clearTimeout(this[X.nextTickHandle]),this[X.nextTickHandle]=null,void(this[X.onTick]=null)):void console.warn("Timer has not been started yet.")},e.prototype[X.scheduleTick]=function(){var e=this;this[X.started]&&!this[X.nextTickHandle]&&(this[X.nextTickHandle]=setTimeout(function(){new Promise(function(t){return t(e[X.onTick]())})["catch"](function(e){console.error("onTick handler failed, scheduling next tick anyway: %o",e)}).then(function(){e[X.nextTickHandle]=null,e[X.scheduleTick]()})},this.interval))},o(e,[{key:"started",get:function(){return this[X.started]}}]),e}(),te=Object.freeze({origin:Symbol("origin"),online:Symbol("online"),lastSeenOnline:Symbol("lastSeenOnline"),pingTimer:Symbol("pingTimer"),ping:Symbol("ping")}),ne=function(e){function t(n){i(this,t);var o=s(this,e.call(this,["online"]));if(!n)throw new Error("Origin should be valid non-empty string.");return o[te.ping]=o[te.ping].bind(o),o[te.origin]=n,o[te.online]=!1,o[te.lastSeenOnline]=0,o[te.pingTimer]=new ee(Number.POSITIVE_INFINITY),Object.seal(o),o}return r(t,e),t.prototype.seenOnline=function(){this[te.online]=!0,this[te.lastSeenOnline]=Date.now()},t.prototype.enableAutoPing=function(e){if("number"!=typeof e||0>e)throw new Error("Interval should valid positive number.");this[te.pingTimer].interval=e,this[te.pingTimer].started||this[te.pingTimer].start(this[te.ping])},t.prototype.disableAutoPing=function(){this[te.pingTimer].started&&this[te.pingTimer].stop()},t.prototype.ping=function(){return this[te.ping](!0)},t.prototype[te.ping]=function(e){var t=this,n=Date.now()-this[te.lastSeenOnline]<this[te.pingTimer].interval;return e||!n&&!document.hidden?fetch(`${this[te.origin]}/ping`,{cache:"no-store"}).then(function(e){return e.ok},function(e){return console.error("Error occurred while pinging box: %o",e),!1}).then(function(e){if(e&&(t[te.lastSeenOnline]=Date.now()),t[te.online]!==e)return t[te.online]=e,t.emit("online",e),e}):Promise.resolve()},o(t,[{key:"origin",get:function(){return this[te.origin]}},{key:"online",get:function(){return this[te.online]}}]),t}(U),ie=Object.freeze({settings:Symbol("settings"),localLink:Symbol("localLink"),tunnelLink:Symbol("tunnelLink"),linkPingInterval:Symbol("linkPingInterval"),online:Symbol("online"),fetch:Symbol("fetch"),pingLinks:Symbol("pingLinks"),updateLink:Symbol("updateLink"),onLinkOnlineChange:Symbol("onLinkOnlineChange"),onLinkOriginChange:Symbol("onLinkOriginChange")}),oe=function(e){function t(n){i(this,t);var o=s(this,e.call(this,["online"]));return o[ie.settings]=n,o[ie.localLink]=null,o[ie.tunnelLink]=null,o[ie.linkPingInterval]=null,o[ie.online]=!1,o[ie.pingLinks]=o[ie.pingLinks].bind(o),o[ie.onLinkOnlineChange]=o[ie.onLinkOnlineChange].bind(o),o[ie.onLinkOriginChange]=o[ie.onLinkOriginChange].bind(o),Object.seal(o),o}return r(t,e),t.prototype.init=function(){return window.addEventListener("online",this[ie.pingLinks]),window.addEventListener("offline",this[ie.pingLinks]),"connection"in navigator&&"onchange"in navigator.connection?(navigator.connection.addEventListener("change",this[ie.pingLinks]),this[ie.linkPingInterval]=this[ie.settings].onlineCheckingLongInterval):this[ie.linkPingInterval]=this[ie.settings].onlineCheckingInterval,this[ie.settings].on("local-origin",this[ie.onLinkOriginChange]),this[ie.settings].on("tunnel-origin",this[ie.onLinkOriginChange]),this[ie.onLinkOriginChange](),Promise.resolve()},t.prototype.fetchJSON=function(e){var t=arguments.length<=1||void 0===arguments[1]?"GET":arguments[1],n=arguments.length<=2||void 0===arguments[2]?void 0:arguments[2];return this[ie.fetch](e,"application/json",t,n).then(function(e){return e.json()})},t.prototype.fetchBlob=function(e,t,n,i){return this[ie.fetch](e,t,n,i).then(function(e){return e.blob()})},t.prototype[ie.fetch]=function(e,t){var n=this,i=arguments.length<=2||void 0===arguments[2]?"GET":arguments[2],o=arguments.length<=3||void 0===arguments[3]?void 0:arguments[3];i=i.toUpperCase();var r={method:i,headers:{Accept:t},cache:"no-store"};return"POST"!==i&&"PUT"!==i&&"DELETE"!==i||(r.headers["Content-Type"]="application/json;charset=UTF-8"),this[ie.settings].session&&(r.headers.Authorization=`Bearer ${this[ie.settings].session}`),void 0!==o&&(r.body=JSON.stringify(o)),fetch(e,r).then(function(t){if(!t.ok)throw new TypeError(`The response returned a ${t.status} HTTP status code.`);var i=new URL(e).origin;return n[ie.localLink]&&n[ie.localLink].origin===i?n[ie.localLink].seenOnline():n[ie.tunnelLink]&&n[ie.tunnelLink].origin===i&&n[ie.tunnelLink].seenOnline(),t})["catch"](function(e){throw console.error("Error occurred while fetching content: ",e),e})},t.prototype[ie.pingLinks]=function(){this[ie.localLink]&&this[ie.localLink].ping(),this[ie.tunnelLink]&&this[ie.tunnelLink].ping()},t.prototype[ie.updateLink]=function(e,t){var n=this[e];!t&&!n||n&&n.origin===t||(n&&(n.off("online",this[ie.onLinkOnlineChange]),n.disableAutoPing(),this[e]=null),t&&(this[e]=new ne(t),this[e].enableAutoPing(this[ie.linkPingInterval]),this[e].on("online",this[ie.onLinkOnlineChange]),this[e].ping()),this[ie.onLinkOnlineChange]())},t.prototype[ie.onLinkOriginChange]=function(){this[ie.updateLink](ie.localLink,this.localOrigin),this[ie.updateLink](ie.tunnelLink,this.tunnelOrigin)},t.prototype[ie.onLinkOnlineChange]=function(){var e=!!this[ie.localLink]&&this[ie.localLink].online||!!this[ie.tunnelLink]&&this[ie.tunnelLink].online;this[ie.online]!==e&&(this[ie.online]=e,this.emit("online",e))},o(t,[{key:"origin",get:function(){if(this[ie.localLink])return this[ie.localLink].origin;if(this[ie.tunnelLink])return this[ie.tunnelLink].origin;throw new Error("Origin is not accessible")}},{key:"localOrigin",get:function(){return this[ie.settings].localOrigin}},{key:"tunnelOrigin",get:function(){return this[ie.settings].tunnelOrigin}},{key:"online",get:function(){return this[ie.online]}}]),t}(U),re=Object.freeze({api:Symbol("api"),service:Symbol("service")}),se=function(){function e(t){if(i(this,e),!t)throw new Error("Service is required!");this[re.service]=t}return o(e,[{key:"id",get:function(){return this[re.service].id}},{key:"label",get:function(){return this[re.service].source&&this[re.service].source.name}},{key:"enabled",get:function(){return this[re.service].status}}]),e}(),ae=function(){function e(t){i(this,e),this[re.api]=t,Object.seal(this)}return e.prototype.getAll=function(){var e=this;return this[re.api].post("services",{channels:[{feature:"thinkerbell/rule-source"}]}).then(function(e){return e.map(function(e){return Object.keys(e.channels).reduce(function(t,n){var i=e.channels[n];switch(i.feature){case"thinkerbell/is-rule-enabled":t.enabled=n;break;case"thinkerbell/rule-source":t.getSource=n;break;case"thinkerbell/remove-rule-id":t.remove=n}return t},{id:e.id,getSource:null,enabled:null,remove:null,status:null,source:null})})}).then(function(t){var n=t.reduce(function(e,t){return e.enabledSelectors.push({id:t.enabled}),e.sourceSelectors.push({id:t.getSource}),e},{enabledSelectors:[],sourceSelectors:[]}),i=n.enabledSelectors,o=n.sourceSelectors;return Promise.all([e[re.api].put("channels/get",i),e[re.api].put("channels/get",o)]).then(function(e){var n=a(e,2),i=n[0],o=n[1];return t.map(function(e){var t=i[e.enabled],n=o[e.getSource];return!t||t.Error?(console.error("Error occurred while retrieving recipe (%s) status: ",e.id,t?t.Error:"No status"),e.status=!1):e.status="On"===t,!n||n.Error?(console.error("Error occurred while retrieving recipe (%s) source: ",e.id,n?n.Error:"No source"),e.source=null):e.source=JSON.parse(n),new se(e)})})})},e.prototype.getGetters=function(){var e=["clock/time-of-day-seconds","door/is-open","door/is-locked"];return this[re.api].post("channels",e.map(function(e){return{feature:e,supports_fetch:!0}})).then(function(e){return e.map(function(e){var t=void 0,n=[];switch(e.feature){case"clock/time-of-day-seconds":t="Everyday",n.push.apply(n,[{label:"in the morning",value:{Geq:{Duration:28800}}},{label:"in the afternoon",value:{Geq:{Duration:50400}}},{label:"in the evening",value:{Geq:{Duration:64800}}}]);break;case"door/is-open":t="Motion Sensor",n.push({label:"detects motion",value:"Open"});break;case"door/is-locked":t="Door",n.push({label:"is locked",value:"Locked"},{label:"is unlocked",value:"Unlocked"})}return{id:e.id,feature:e.feature,name:t||e.adapter,tags:e.tags,options:n}})})},e.prototype.getSetters=function(){var e=["speak/sentence","camera/store-snapshot","light/is-on","door/is-locked"];return this[re.api].post("channels",e.map(function(e){return{feature:e,supports_send:!0}})).then(function(e){return e.map(function(e){var t=[],n=void 0;switch(e.feature){case"speak/sentence":n="say",t.push.apply(t,[{label:'"Good morning!"',value:'"Good morning!"'},{label:'"Good afternoon!"',value:'"Good afternoon!"'},{label:'"Good evening!"',value:'"Good evening!"'}]);break;case"camera/store-snapshot":n="camera",t.push.apply(t,[{label:"takes a picture",value:null},{label:"sends me a picture",value:[{destination:[{id:e.id}],feature:"camera/store-snapshot",value:null},{destination:[{feature:"webpush/notify-msg"}],feature:"webpush/notify-msg",value:{message:JSON.stringify({message:"Your bedroom patio door has just been opened. Here is a picture of what I see.",action:`dev/camera-latest-image/${e.service}`}),resource:"res1"}}]}]);break;case"light/is-on":n="light",t.push.apply(t,[{label:"gets turned on",value:"On"},{label:"gets turned off",value:"Off"}]);break;case"door/is-locked":n="door lock",t.push.apply(t,[{label:"locks the door",value:"Locked"},{label:"unlocks the door",value:"Unlocked"}])}return{id:e.id,feature:e.feature,name:n||e.adapter,tags:e.tags,options:t}})})},e.prototype.add=function(e){var t=e.name,n=e.getter,i=e.getterValue,o=e.setter,r=e.setterValue,s=void 0;s=Array.isArray(r.value)?r.value:[{destination:[{id:o.id}],feature:o.feature,value:r.value}];var a={name:t,rules:[{conditions:[{source:[{id:n.id}],feature:n.feature,when:i.value}],execute:s}]};return this[re.api].put("channels/set",{select:{feature:"thinkerbell/add-rule"},value:{name:t,source:JSON.stringify(a)}})},e.prototype.remove=function(e){return this[re.api].put("channels/set",{select:{id:e[re.service].remove},value:null})},e.prototype.toggle=function(e){var t=arguments.length<=1||void 0===arguments[1]||arguments[1];return this[re.api].put("channels/set",{select:{id:e[re.service].enabled},value:t?"On":"Off"}).then(function(){e[re.service].status=t})},e.prototype.createDemoRecipes=function(){var e=this;Promise.all([this.getGetters(),this.getSetters()]).then(function(t){var n=a(t,2),i=n[0],o=n[1],r=i.find(function(e){return"clock/time-of-day-seconds"===e.feature}),s=o.filter(function(e){return"light/is-on"===e.feature}),c=[{source:[{id:r.id}],feature:"clock/time-of-day-seconds",when:{Geq:{Duration:28800}}}],l=[].concat(s.map(function(e){return{destination:[{id:e.id}],feature:e.feature,value:"Off"}}),[{destination:[{feature:"webpush/notify-msg"}],feature:"webpush/notify-msg",value:{message:JSON.stringify({message:"Hello Alex, I've turned your kitchen lights off for you. Have a wonderful day!"}),resource:"res1"}}]),u={name:"Turn off the lights when I leave for work.",rules:[{conditions:c,execute:l}]};return console.log("Recipe for the demo",u),e[re.api].put("channels/set",{select:{feature:"thinkerbell/add-rule"},value:{name:u.name,source:JSON.stringify(u)}})}),this.createDoorLockDemoRecipe()},e.prototype.createDoorLockDemoRecipe=function(){var e=this;Promise.all([this.getGetters(),this.getSetters()]).then(function(t){var n=a(t,2),i=n[0],o=n[1],r=i.find(function(e){return"clock/time-of-day-seconds"===e.feature}),s=i.find(function(e){return"door/is-locked"===e.feature}),c=o.find(function(e){return"door/is-locked"===e.feature}),l=[{source:[{id:r.id}],feature:"clock/time-of-day-seconds",when:{Geq:{Duration:28800}}},{source:[{id:s.id}],feature:s.feature,when:"Unlocked"}],u=[{destination:[{id:c.id}],feature:c.feature,value:"Locked"},{destination:[{feature:"webpush/notify-msg"}],feature:"webpush/notify-msg",value:{message:JSON.stringify({message:"Hello Alex, I've locked the door for you. Have a wonderful day!"}),resource:"res1"}}],h={name:"Lock the door when I leave for work.",rules:[{conditions:l,execute:u}]};return e[re.api].put("channels/set",{select:{feature:"thinkerbell/add-rule"},value:{name:h.name,source:JSON.stringify(h)}})})},e}(),ce=Object.freeze({api:Symbol("api"),settings:Symbol("settings"),listenForMessages:Symbol("listenForMessages")}),le=function(e){function t(n,o){i(this,t);var r=s(this,e.call(this,["message"]));return r[ce.api]=n,r[ce.settings]=o,Object.seal(r),r}return r(t,e),t.prototype.subscribeToNotifications=function(){var e=this,t=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];if(!navigator.serviceWorker)return Promise.reject("No service worker supported");navigator.serviceWorker.addEventListener("message",this[ce.listenForMessages].bind(this));var n=this[ce.settings];return n.pushEndpoint&&n.pushPubKey&&n.pushAuth&&!t?Promise.resolve():navigator.serviceWorker.ready.then(function(e){return e.pushManager.subscribe({userVisibleOnly:!0})}).then(function(t){var i=t.endpoint,o=t.getKey?t.getKey("p256dh"):"",r=t.getKey?t.getKey("auth"):"";n.pushEndpoint=i,n.pushPubKey=btoa(String.fromCharCode.apply(null,new Uint8Array(o))),n.pushAuth=btoa(String.fromCharCode.apply(null,new Uint8Array(r)));var s=[[[{id:"channel:subscribe.webpush@link.mozilla.org"}],{subscriptions:[{public_key:n.pushPubKey,push_uri:n.pushEndpoint,auth:n.pushAuth}]}]];return e[ce.api].put("channels/set",s)}).then(function(){var t=[[[{id:"channel:resource.webpush@link.mozilla.org"}],{resources:["res1"]}]];return e[ce.api].put("channels/set",t)})["catch"](function(e){if("denied"===Notification.permission)throw new Error("Permission request was denied.");throw console.error("Error while saving subscription ",e),new Error(`Subscription error: ${e}`)})},t.prototype[ce.listenForMessages]=function(e){var t=e.data||{};t.action&&this.emit("message",t)},t}(U),ue="unknown",he=Object.freeze({api:Symbol("api"),id:Symbol("id"),manufacturer:Symbol("manufacturer"),model:Symbol("model"),name:Symbol("name"),watchers:Symbol("watchers"),tags:Symbol("tags"),channels:Symbol("channels"),getChannels:Symbol("getChannel"),getFetchChannel:Symbol("getFetchChannel"),getSendChannel:Symbol("getSendChannel")}),de=function(e){function t(n,o,r,a){i(this,t);var c=s(this,e.call(this,r));return c[he.api]=o,c[he.id]=n.id,c[he.manufacturer]=n.properties&&n.properties.manufacturer||"",c[he.model]=n.properties&&n.properties.model||"",c[he.name]=n.properties&&n.properties.name||n.properties.product_name||"",c[he.tags]=new Set(n.tags),c[he.channels]=n.channels,c[he.watchers]=a||new Map,c}return r(t,e),t.prototype.set=function(e){var t=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return this[he.api].put("channels/set",{select:{id:this[he.getSendChannel](e).id},value:t})},t.prototype.get=function(e){var t=this[he.getFetchChannel](e),n=t.supports_fetch.returns,i={id:t.id};return n&&"Binary"===(n.requires||n.optional)?this[he.api].blob("channels/get",i):this[he.api].put("channels/get",i).then(function(e){return e[t.id]})},t.prototype.watch=function(e,t){var n=this,i=this[he.watchers].get(e);if(!i)throw new Error("Unsupported watcher `${alias}`!");var o=a(i,3),r=o[0],s=o[1],c=o[2],l=void 0===c?new Map:c;0===l.size&&i.push(l);var u=l.get(t);u||(u=function(e){return t(n[s](e))},l.set(t,u));var h=this[he.getFetchChannel](r),d=h.id;this[he.api].watch(d,u)},t.prototype.unwatch=function(e,t){var n=this[he.watchers].get(e);if(!n)throw new Error("Unsupported watcher `${alias}`!");var i=a(n,3),o=i[0],r=i[2],s=r.get(t);r["delete"](t);var c=this[he.getFetchChannel](o),l=c.id;this[he.api].unwatch(l,s)},t.prototype.getTags=function(){return Array.from(this[he.tags])},t.prototype.addTag=function(e){var t=this;if(!e||"string"!=typeof e)throw new Error("Tag should be valid non-empty string.");if(this[he.tags].has(e))return Promise.resolve();this[he.tags].add(e);var n={services:{id:this[he.id]},tags:e},i={channels:{service:this[he.id]},tags:e};return Promise.all([this[he.api].post("services/tags",n),this[he.api].post("channels/tags",i)])["catch"](function(n){throw t[he.tags]["delete"](e),n})},t.prototype.removeTag=function(e){var t=this;if(!e||"string"!=typeof e)throw new Error("Tag should be valid non-empty string.");if(!this[he.tags].has(e))return Promise.resolve();this[he.tags]["delete"](e);var n={services:{id:this[he.id]},tags:e},i={channels:{service:this[he.id]},tags:e};return Promise.all([this[he.api]["delete"]("services/tags",n),this[he.api]["delete"]("channels/tags",i)])["catch"](function(n){throw t[he.tags].add(e),n})},t.prototype.teardown=function(){for(var e of this[he.watchers].values()){var t=a(e,3),n=t[0],i=t[2];if(i&&0!==i.size){var o=this[he.getFetchChannel](n),r=o.id;for(var s of i.values())console.warn(`Forgotten watcher for ${r}!`),this[he.api].unwatch(r,s);i.clear()}}},t.prototype[he.getChannels]=function(e){var t=this;if(e.id){var n=this[he.channels][e.id];return n?[n]:[]}if(e.feature||"string"==typeof e){var i=function(){var n=e.feature||e;return{v:Object.keys(t[he.channels]).reduce(function(e,i){var o=t[he.channels][i];return o.feature===n&&e.push(o),e},[])}}();if("object"==typeof i)return i.v}return[]},t.prototype[he.getFetchChannel]=function(e){var t=this[he.getChannels](e).find(function(e){return e.supports_fetch});if(!t)throw new Error(`Couldn't find channel that supports "fetch" with selector: ${e}`);return t},t.prototype[he.getSendChannel]=function(e){var t=this[he.getChannels](e).find(function(e){return e.supports_send});if(!t)throw new Error(`Couldn't find channel that supports "send" with selector: ${e}`);return t},o(t,[{key:"type",get:function(){return ue}},{key:"id",get:function(){return this[he.id]}},{key:"manufacturer",get:function(){return this[he.manufacturer]}},{key:"model",get:function(){return this[he.model]}},{key:"name",get:function(){return this[he.name]}}]),t}(U),pe="ip-camera",fe=function(e){function t(n,o){i(this,t);var r=s(this,e.call(this,n,o));return Object.seal(r),r}return r(t,e),t.prototype.getLatestImage=function(){return this.get("camera/x-latest-image")},t.prototype.takeSnapshot=function(){var e=this;return this.set("camera/store-snapshot").then(function(){return e.get("camera/x-latest-image")})},o(t,[{key:"type",get:function(){return pe}}]),t}(de),ve="light",ge=function(e){function t(n,o){i(this,t);var r=s(this,e.call(this,n,o));return Object.seal(r),r}return r(t,e),t.prototype.isAvailable=function(){return this.get("device/available").then(function(e){return"On"===e})},t.prototype.isOn=function(){return this.get("light/is-on").then(function(e){return"On"===e})},t.prototype.turn=function(e){return this.set("light/is-on",e?"On":"Off")},o(t,[{key:"type",get:function(){return ve}}]),t}(de),me="door-lock",be=function(e){function t(n,o){i(this,t);var r=s(this,e.call(this,n,o));return Object.seal(r),r}return r(t,e),t.prototype.isLocked=function(){return this.get("door/is-locked").then(function(e){return"Locked"===e})},t.prototype.lockUnlock=function(e){return this.set("door/is-locked",e?"Locked":"Unlocked")},o(t,[{key:"type",get:function(){return me}}]),t}(de),ye="motion-sensor",Se=Object.freeze({onMotionStateChanged:Symbol("onMotionStateChanged")}),we=function(e){return!!e&&"Open"===e},ke=function(e){function t(n,o){i(this,t);var r=s(this,e.call(this,n,o,void 0,new Map([["motion",["door/is-open",Se.onMotionStateChanged]]])));return Object.freeze(r),r}return r(t,e),t.prototype.isMotionDetected=function(){return this.get("door/is-open").then(we)},t.prototype[Se.onMotionStateChanged]=function(e){return we(e)},o(t,[{key:"type",get:function(){return ye}}]),t}(de),xe=Object.freeze({api:Symbol("api"),settings:Symbol("settings"),db:Symbol("db"),cache:Symbol("services"),pollingTimer:Symbol("pollingTimer"),getServiceInstance:Symbol("getServiceInstance"),hasChannelWithFeature:Symbol("hasChannelWithFeature"),getCache:Symbol("getCache")}),_e=function(e,t){var n=Object.keys(e),i=Object.keys(t);return n.length===i.length&&!n.some(function(n){var i=e[n],o=t[n],r=typeof i;return r!==typeof o||("object"!==r||null===i||null===o?i!==o:Array.isArray(i)?i.length!==o.length||i.some(function(e,t){return e!==o[t]}):!_e(i,o))})},Le=function(e){function t(n,o,r){i(this,t);var a=s(this,e.call(this,["services-changed","service-changed"]));return a[xe.db]=n,a[xe.api]=o,a[xe.settings]=r,a[xe.cache]=null,a[xe.pollingTimer]=new ee(a[xe.settings].servicePollingInterval),Object.seal(a),a}return r(t,e),t.prototype.getAll=function(){return this[xe.getCache]().then(function(e){return Array.from(e.values())})},t.prototype.get=function(e){return this[xe.getCache]().then(function(t){return t.get(e)})},t.prototype.togglePolling=function(e){e!==this[xe.pollingTimer].started&&(e?this[xe.pollingTimer].start(this.sync.bind(this)):this[xe.pollingTimer].stop())},t.prototype.sync=function(){var e=this;return Promise.all([this[xe.api].get("services"),this[xe.db].getServices(),this[xe.getCache]()]).then(function(t){var n=a(t,3),i=n[0],o=n[1],r=n[2],s=0;i.forEach(function(t){var n=o.find(function(e){return e.id===t.id}),i=!!n;if(!i||!_e(t,n)){e[xe.db].setService(t);var a=e[xe.getServiceInstance](t);r.set(a.id,a),i?e.emit("service-changed",a):s++}});var c=o.length+s-i.length;c>0&&o.forEach(function(t){var n=i.find(function(e){return e.id===t.id});if(!n){e[xe.db].deleteService(t);var o=r.get(t.id);o.teardown(),r["delete"](o.id)}}),(s>0||c>0)&&e.emit("services-changed")})},t.prototype[xe.getCache]=function(){var e=this;return this[xe.cache]?this[xe.cache]:this[xe.cache]=this[xe.db].getServices()["catch"](function(e){return console.error("Could not load services from the local DB: %o",e),[]}).then(function(t){var n=new Map;return t.forEach(function(t){n.set(t.id,e[xe.getServiceInstance](t))}),n})},t.prototype[xe.getServiceInstance]=function(e){switch(e.adapter){case"ip-camera@link.mozilla.org":return new fe(e,this[xe.api]);case"philips_hue@link.mozilla.org":return new ge(e,this[xe.api]);case"OpenZwave Adapter":return this[xe.hasChannelWithFeature](e.channels,"door/is-locked")?new be(e,this[xe.api]):this[xe.hasChannelWithFeature](e.channels,"door/is-open")?new ke(e,this[xe.api]):new de(e,this[xe.api]);default:return new de(e,this[xe.api])}},t.prototype[xe.hasChannelWithFeature]=function(e,t){return Object.keys(e).some(function(n){return e[n].feature===t})},t}(U),Oe=Object.freeze({settings:Symbol("settings"),net:Symbol("net"),watchTimer:Symbol("watchTimer"),watchEventBus:Symbol("watchEventBus"),watchChannels:Symbol("watchChannels"),getURL:Symbol("getURL"),onceOnline:Symbol("onceOnline"),onceAuthenticated:Symbol("onceAuthenticated"),onceDocumentVisible:Symbol("onceDocumentVisible"),onceReady:Symbol("onceReady"),getChannelValues:Symbol("getChannelValues"),updateChannelValue:Symbol("updateChannelValue")}),Ce=function(){function e(t,n){i(this,e),this[Oe.net]=t,this[Oe.settings]=n,this[Oe.watchTimer]=new ee(this[Oe.settings].watchInterval),this[Oe.watchEventBus]=new U,this[Oe.watchChannels]=new Map,this[Oe.getChannelValues]=this[Oe.getChannelValues].bind(this),Object.freeze(this)}return e.prototype.get=function(e){var t=this;return this[Oe.onceReady]().then(function(){return t[Oe.net].fetchJSON(t[Oe.getURL](e))})},e.prototype.post=function(e,t){var n=this;return this[Oe.onceReady]().then(function(){return n[Oe.net].fetchJSON(n[Oe.getURL](e),"POST",t)})},e.prototype.put=function(e,t){var n=this;return this[Oe.onceReady]().then(function(){return n[Oe.net].fetchJSON(n[Oe.getURL](e),"PUT",t)})},e.prototype["delete"]=function(e,t){var n=this;return this[Oe.onceReady]().then(function(){return n[Oe.net].fetchJSON(n[Oe.getURL](e),"DELETE",t)})},e.prototype.blob=function(e,t){var n=this,i=arguments.length<=2||void 0===arguments[2]?"image/jpeg":arguments[2];return this[Oe.onceReady]().then(function(){return t?n[Oe.net].fetchBlob(n[Oe.getURL](e),i,"PUT",t):n[Oe.net].fetchBlob(n[Oe.getURL](e),i)})},e.prototype.watch=function(e,t){this[Oe.watchEventBus].on(e,t),this[Oe.watchChannels].has(e)||(this[Oe.watchChannels].set(e,{id:e,value:null}),this[Oe.watchTimer].started||this[Oe.watchTimer].start(this[Oe.getChannelValues]))},e.prototype.unwatch=function(e,t){return this[Oe.watchChannels].has(e)?(this[Oe.watchEventBus].off(e,t),this[Oe.watchEventBus].hasListeners(e)||this[Oe.watchChannels]["delete"](e),void(0===this[Oe.watchChannels].size&&this[Oe.watchTimer].stop())):void console.warn('Channel with id "%s" is not watched.',e)},e.prototype[Oe.getURL]=function(e){if(!e||"string"!=typeof e)throw new Error("Path should be valid non-empty string.");return`${this[Oe.net].origin}/api/v${this[Oe.settings].apiVersion}/${e}`},e.prototype[Oe.onceReady]=function(){return Promise.all([this[Oe.onceOnline](),this[Oe.onceAuthenticated](),this[Oe.onceDocumentVisible]()])},e.prototype[Oe.onceOnline]=function(){var e=this[Oe.net];return e.online?Promise.resolve():new Promise(function(t){return e.once("online",function(){return t()})})},e.prototype[Oe.onceAuthenticated]=function(){var e=this[Oe.settings];return e.session?Promise.resolve():new Promise(function(t){return e.once("session",function(){return t()})})},e.prototype[Oe.onceDocumentVisible]=function(){return document.hidden?new Promise(function(e){document.addEventListener("visibilitychange",function t(){document.hidden||(document.removeEventListener("visibilitychange",t),e())})}):Promise.resolve();
},e.prototype[Oe.getChannelValues]=function(){var e=this;if(0===this[Oe.watchChannels].size)return Promise.resolve();var t=Array.from(this[Oe.watchChannels].values()).map(function(e){var t=e.id;return{id:t}});return this.put("channels/get",t).then(function(t){Object.keys(t).forEach(function(n){var i=e[Oe.watchChannels].get(n);i&&e[Oe.updateChannelValue](i,t[n])})})},e.prototype[Oe.updateChannelValue]=function(e,t){var n=!1;if(t&&e.value){var i=Object.keys(t),o=a(i,1),r=o[0];if("Error"===r)return void console.error("Failed to retrieve value for channel (%s): %o",e.id,t[r]);n=t&&e.value&&"object"==typeof e.value?JSON.stringify(t)!==JSON.stringify(e.value):t!==e.value}else n=t!==e.value;n&&(e.value=Object.freeze(t),this[Oe.watchEventBus].emit(e.id,e.value))},e}(),Ne=Object.freeze({settings:Symbol("settings"),db:Symbol("db"),net:Symbol("net"),boxes:Symbol("boxes"),webPush:Symbol("webPush"),api:Symbol("api")}),Ee=function(e){function t(){var n=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],o=n.settings,r=n.db,a=n.net;i(this,t);var c=s(this,e.call(this,["push-message","online","discovery"]));return c[Ne.settings]=o||new W,c[Ne.db]=r||new Q,c[Ne.net]=a||new oe(c[Ne.settings]),c[Ne.boxes]=Object.freeze([]),c[Ne.api]=new Ce(c[Ne.net],c[Ne.settings]),c[Ne.webPush]=new le(c[Ne.api],c[Ne.settings]),c.services=new Le(c[Ne.db],c[Ne.api],c[Ne.settings]),c.recipes=new ae(c[Ne.api]),Object.seal(c),c}return r(t,e),t.prototype.init=function(){var e=this;return window.foxbox=this,this[Ne.net].on("online",function(t){return e.emit("online",t)}),this[Ne.webPush].on("message",function(t){return e.emit("push-message",t)}),this._initDiscovery().then(function(){return e[Ne.net].init()}),this._initUserSession().then(function(){return e[Ne.db].init()})},t.prototype.clear=function(e){var t=[this[Ne.settings].clear(),this[Ne.db].clear()];return navigator.serviceWorker?(e||t.push(navigator.serviceWorker.ready.then(function(e){return e.unregister()})),Promise.all(t)):Promise.all(t)},t.prototype._initDiscovery=function(){var e=this;return this[Ne.settings].skipDiscovery?Promise.resolve():this[Ne.net].fetchJSON(this[Ne.settings].registrationService).then(function(t){if(!Array.isArray(t))return void console.warn("Got unexpected response from registry server",t);var n=Math.floor(Date.now()/1e3)-120;if(e[Ne.boxes]=Object.freeze(t.filter(function(e){return e.timestamp-n>=0}).map(function(e){var t=JSON.parse(e.message),n=t.local_origin,i=t.tunnel_origin,o=e.client;return Object.freeze({local_origin:n,tunnel_origin:i,client:o})})),e.emit("discovery"),!e[Ne.boxes].length&&!e[Ne.settings].localOrigin&&!e[Ne.settings].tunnelOrigin)throw new Error("Registration service did not return any boxes.");e[Ne.settings].configured||1!==e[Ne.boxes].length||e.selectBox()})["catch"](function(t){if(!e[Ne.settings].localOrigin&&!e[Ne.settings].tunnelOrigin)return console.warn("Retrying box discovery... Reason is %o",t),new Promise(function(t){setTimeout(function(){e._initDiscovery().then(t,t)},1e3)})})},t.prototype.selectBox=function(){var e=arguments.length<=0||void 0===arguments[0]?0:arguments[0];if(!this[Ne.boxes].length)return this[Ne.settings].configured=!1,void console.error("No boxes found. Is this app online? Is the box online?");if(e>=this[Ne.boxes].length)return this[Ne.settings].configured=!1,void console.error("Index out of range.");var t=this[Ne.boxes][e];this[Ne.settings].localOrigin=t.local_origin,t.tunnel_origin?this[Ne.settings].tunnelOrigin=t.tunnel_origin:this[Ne.settings].tunnelOrigin="",this[Ne.settings].client=t.client,this[Ne.settings].configured=!0},t.prototype._initUserSession=function(){if(this.isLoggedIn)return Promise.resolve();var e=new URL(location.href),t=new URLSearchParams(e.search.substring(1));return t.has("session_token")?(this[Ne.settings].session=t.get("session_token").replace(/ /g,"+"),t["delete"]("session_token"),e.search=t,location.replace(e.href),Promise.reject()):Promise.resolve()},t.prototype.login=function(){if(!this.isLoggedIn){var e=encodeURIComponent(location);location.replace(`${this[Ne.net].origin}/?redirect_url=${e}`)}},t.prototype.logout=function(){this[Ne.settings].session=null},t.prototype.subscribeToNotifications=function(){var e=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];return this[Ne.webPush].subscribeToNotifications(e)},o(t,[{key:"online",get:function(){return this[Ne.net].online}},{key:"client",get:function(){return this[Ne.settings].client}},{key:"boxes",get:function(){return this[Ne.boxes]}},{key:"isLoggedIn",get:function(){return!!this[Ne.settings].session}}]),t}(U),Ie=Object.freeze({controllers:Symbol("controllers"),onHashChanged:Symbol("onHashChanged")}),Te=function(e){function t(){i(this,t);var n=s(this,e.call(this)),o=n.foxbox=new Ee,r=document.querySelector(".app-view-container"),a={foxbox:o,mountNode:r},c=new v(a),l=new T(a);return n[Ie.controllers]={"":c,"users/(.+)":c,services:new y(a),"services/(.+)/tags":new C(a),"services/(.+)":new _(a),themes:l,"themes/(.+)":l,"dev/(.+)/(.+)":new j(a)},window.addEventListener("hashchange",n[Ie.onHashChanged].bind(n)),n}return r(t,e),t.prototype.main=function(){var e=this;this.foxbox.init().then(function(){e.foxbox.isLoggedIn?(e.foxbox.subscribeToNotifications(),e.foxbox.services.sync(),""===location.hash&&(location.hash="#services"),e.foxbox.on("push-message",function(e){e.action&&(location.hash=e.action)})):location.hash="#users/login",e[Ie.onHashChanged]()})},t.prototype[Ie.onHashChanged]=function(){var e=window.location.hash.slice(1);for(var t of Object.keys(this[Ie.controllers])){var n=e.match(new RegExp(`^${t}$`));if(n){var i;(i=this[Ie.controllers][t]).main.apply(i,c(n.slice(1)));break}}},t}(l),Pe=new Te;Pe.main()});
//# sourceMappingURL=app.js.map
