define(["components/mvc","components/react","components/react-dom"],function(e,t,n){"use strict";t="default"in t?t["default"]:t,n="default"in n?n["default"]:n;var i=function(){var e="function"==typeof Symbol&&Symbol["for"]&&Symbol["for"]("react.element")||60103;return function(t,n,i,o){var r=t&&t.defaultProps,s=arguments.length-3;if(n||0===s||(n={}),n&&r)for(var a in r)void 0===n[a]&&(n[a]=r[a]);else n||(n=r||{});if(1===s)n.children=o;else if(s>1){for(var c=Array(s),l=0;s>l;l++)c[l]=arguments[l+3];n.children=c}return{$$typeof:e,type:t,key:void 0===i?null:""+i,ref:null,props:n,_owner:null}}}(),o=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},a=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},c=function(){function e(e,t){var n=[],i=!0,o=!1,r=void 0;try{for(var s,a=e[Symbol.iterator]();!(i=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);i=!0);}catch(c){o=!0,r=c}finally{try{!i&&a["return"]&&a["return"]()}finally{if(o)throw r}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),l=function(e){function t(n){o(this,t);var i=a(this,e.call(this,n));return i.foxbox=n.foxbox,i}return s(t,e),t.prototype.shouldComponentUpdate=function(){return!1},t.prototype.handleOnClick=function(){this.foxbox.logout()},t.prototype.render=function(){var e=location.hash.substr(1).split("/").shift(),t=[{id:"services",label:"Home"},{id:"themes",label:"Themes"},{id:"mr-fox",label:"Mr. Fox"}].map(function(t){var n="navigation-menu__item";return e===t.id&&(n+=" navigation-menu__item--active"),i("li",{className:n},t.id,i("a",{href:`#${t.id}`,className:"navigation-menu__item-link"},void 0,t.label))});return i("ul",{className:"navigation-menu"},void 0,t,i("li",{className:"navigation-menu__item"},void 0,i("a",{href:"#users/login",className:"navigation-menu__item-link user-logout-button",onClick:this.handleOnClick.bind(this)},void 0,"Log out")))},t}(t.Component),u=function(e){function t(){return o(this,t),a(this,e.apply(this,arguments))}return s(t,e),t.prototype.renderHeader=function(e,t){var n="app-view__header";return t&&(n+=` ${t}`),i("header",{className:n},void 0,i("h1",{},void 0,e))},t.prototype.renderFooter=function(){return i("footer",{className:"app-view__footer"},void 0,i(l,{foxbox:this.props.foxbox}))},t.prototype.renderBody=function(){return null},t.prototype.render=function(){return i("div",{className:"app-view"},void 0,this.renderHeader(),i("section",{className:"app-view__body"},void 0,this.renderBody()),this.renderFooter())},t}(t.Component),h=function(e){function t(n){o(this,t);var i=a(this,e.call(this,n));return i.state={boxes:n.foxbox.boxes,selectedBox:null,loginEnabled:n.foxbox.online},i.foxbox=n.foxbox,i.onBoxOnline=i.onBoxOnline.bind(i),i.onBoxDiscovery=i.onBoxDiscovery.bind(i),i.onSelectChange=i.onSelectChange.bind(i),i.onFormSubmit=i.onFormSubmit.bind(i),i}return s(t,e),t.prototype.componentDidMount=function(){this.foxbox.addEventListener("online",this.onBoxOnline),this.foxbox.addEventListener("discovery",this.onBoxDiscovery)},t.prototype.componentWillUnmount=function(){this.foxbox.removeEventListener("online",this.onBoxOnline),this.foxbox.removeEventListener("discovery",this.onBoxDiscovery)},t.prototype.onSelectChange=function(e){var t=e.target.selectedIndex;this.setState({selectedBox:t}),this.foxbox.selectBox(t)},t.prototype.onFormSubmit=function(e){e.preventDefault(),this.foxbox.login()},t.prototype.onBoxOnline=function(e){this.setState({loginEnabled:e})},t.prototype.onBoxDiscovery=function(){this.setState({boxes:this.foxbox.boxes})},t.prototype.renderHeader=function(){return e.prototype.renderHeader.call(this,"Project Link","app-view__header--white")},t.prototype.renderFooter=function(){return null},t.prototype.renderBody=function(){var e=this,t=null;if(this.state.boxes.length>1){var n=this.state.selectedBox||0,o=this.state.boxes.map(function(t,o){return t.client===e.foxbox.client&&(n=o),i("option",{value:o},t.client,t.client)});t=i("select",{className:"user-login__box-selector",value:n,onChange:this.onSelectChange},void 0,o)}return i("form",{className:"app-view__fill-body user-login",onSubmit:this.onFormSubmit},void 0,i("img",{className:"user-login__logo",src:"img/icon.svg"}),t,i("button",{className:"user-login__login-button",disabled:!this.state.loginEnabled},void 0,"Connect to your box"))},t}(u),d=["login","logout"],p=d[0],f=function(e){function i(){return o(this,i),a(this,e.apply(this,arguments))}return s(i,e),i.prototype.main=function(){var e=arguments.length<=0||void 0===arguments[0]?p:arguments[0];switch(d.includes(e)||(console.error(`Bad users route: "${e}". Falling back to ${p}.`),e=p),e){case"login":this.login();break;case"logout":this.logout()}},i.prototype.login=function(){n.render(t.createElement(h,{foxbox:this.foxbox}),this.mountNode)},i.prototype.logout=function(){this.foxbox.logout(),location.hash="#users/login"},i}(e.Controller),v=function(e){function t(n){o(this,t);var i=a(this,e.call(this,n));return i.state={available:!1,on:!0,locked:!0,motionDetected:!1},i.service=n.service,i.foxbox=n.foxbox,i.onMotion=i.onMotion.bind(i),i}return s(t,e),t.prototype.componentDidMount=function(){var e=this;switch(this.service.type){case"light":this.service.isAvailable().then(function(t){e.setState({available:t})})["catch"](console.error.bind(console)),this.service.isOn().then(function(t){e.setState({on:t})})["catch"](console.error.bind(console));break;case"motion-sensor":this.service.isMotionDetected().then(this.onMotion),this.service.watch("motion",this.onMotion);break;case"door-lock":this.service.isLocked().then(function(t){e.setState({locked:t})})["catch"](function(e){console.error("Can not retrieve door lock status: %o",e)})}},t.prototype.componentWillUnmount=function(){switch(this.service.type){case"motion-sensor":this.service.unwatch("motion",this.onMotion)}},t.prototype.handleLightOnChange=function(e){var t=this,n=e.target.checked;this.setState({on:n}),this.service.turn(n)["catch"](function(e){t.setState({on:!n}),console.error(e)})},t.prototype.onDoorLockUnlock=function(e){var t=this,n=e.target.checked;this.setState({locked:n}),this.service.lockUnlock(n)["catch"](function(e){t.setState({locked:!n}),console.error("Could not change door lock status: %o",e)})},t.prototype.onMotion=function(e){this.setState({motionDetected:e})},t.prototype.getBulbColour=function(){var e=1,t=1,n=1,i=e,o=Math.round(100*t),r=n;return`hsla(${i},${o}%,50%,${r})`},t.prototype.renderLightService=function(){var e=this.state.available,t="Light",n="light";if(void 0!==this.service.model)switch(this.service.model){case"BSB002":n="bridge_v2";break;case"LCT001":case"LCT007":case"LCT010":case"LTW010":case"LWB004":case"LWB006":n="white_and_color_e27_b22";break;case"LWB010":case"LWB014":n="white_e27_b22";break;case"LCT002":case"LCT011":case"LTW011":case"LWB005":case"LWB011":n="br30";break;case"LCT003":n="gu10_par16";break;case"LST001":case"LST002":n="lightstrip";break;case"LLC006":case"LLC010":n="iris";break;case"LLC005":case"LLC011":case"LLC012":case"LLC007":n="bloom";break;case"LLC014":n="aura";break;case"LLC013":n="storylight";break;case"LLC020":n="go";break;case"HBL001":case"HBL002":case"HBL003":n="beyond_ceiling_pendant_table";break;case"HIL001":case"HIL002":n="impulse";break;case"HEL001":case"HEL002":n="entity";break;case"HML001":case"HML002":case"HML003":case"HML004":case"HML005":case"HML006":n="phoenix_ceiling_pendant_table_wall";break;case"HML007":n="phoenix_recessed_spot";break;case"SWT001":n="tap";break;case"RWL021":n="hds"}var o=this.getServiceName(),r=o?i("small",{},void 0,` (${o})`):null;return i("li",{className:"service-list__item","data-icon":n,"data-connected":e},void 0,i("a",{className:"service-list__item-link",href:`#services/${this.service.id}`},void 0,t,r),i("div",{className:"service-list__item-color-picker",style:{background:this.getBulbColour()}},void 0),i("label",{},void 0,i("input",{className:"service-list__on-off-toggle",type:"checkbox",checked:this.state.on,disabled:!e,onChange:this.handleLightOnChange.bind(this)})))},t.prototype.renderDoorLock=function(){var e=this.getServiceName(),t=e?i("small",{},void 0,` (${e})`):null;return i("li",{className:"service-list__item","data-icon":"door-lock"},void 0,i("a",{className:"service-list__item-link",href:`#services/${this.service.id}`},void 0,"Door Lock",t),i("label",{},void 0,i("input",{className:"service-list__on-off-toggle",type:"checkbox",checked:this.state.locked,onChange:this.onDoorLockUnlock.bind(this)})))},t.prototype.renderMotionSensor=function(){var e=this.getServiceName(),t=e?i("small",{},void 0,` (${e})`):null,n="service-list__item motion-sensor-item";return this.state.motionDetected&&(n+=" motion-sensor-item--motion-detected"),i("li",{className:n},void 0,i("a",{className:"service-list__item-link",href:`#services/${this.service.id}`},void 0,"Motion Sensor",t))},t.prototype.renderGenericService=function(){var e=arguments.length<=0||void 0===arguments[0]?"Unknown service":arguments[0],t=arguments.length<=1||void 0===arguments[1]?"unknown":arguments[1],n=this.getServiceName(),o=n?i("small",{},void 0,` (${n})`):null;return i("li",{className:"service-list__item","data-icon":t,"data-connected":"true"},void 0,i("a",{className:"service-list__item-link",href:`#services/${this.service.id}`},void 0,e,o))},t.prototype.render=function(){switch(this.service.type){case"door-lock":return this.renderDoorLock();case"ip-camera":return this.renderGenericService("Camera","ip-camera");case"light":return this.renderLightService();case"motion-sensor":return this.renderMotionSensor();default:return this.renderGenericService()}},t.prototype.getServiceName=function(){return this.service.getTags().join(", ")||this.service.name},t}(t.Component),g=function(e){function t(){return o(this,t),a(this,e.apply(this,arguments))}return s(t,e),t.prototype.render=function(){var e=this,t=this.props.services.filter(function(e){return"unknown"!==e.type}),n=t.map(function(t){return i(v,{service:t,foxbox:e.props.foxbox},t.id)});return i("ul",{className:"service-list"},void 0,n)},t}(t.Component),m=function(e){function t(n){o(this,t);var i=a(this,e.call(this,n));return i.state={services:[],title:"",body:""},i.foxbox=n.foxbox,i.updateServiceList=i.updateServiceList.bind(i),i.updateServiceState=i.updateServiceState.bind(i),i}return s(t,e),t.prototype.componentDidMount=function(){this.updateServiceList(),this.foxbox.services.togglePolling(!0),this.foxbox.services.on("services-changed",this.updateServiceList),this.foxbox.services.on("service-changed",this.updateServiceState)},t.prototype.componentWillUnmount=function(){this.foxbox.services.togglePolling(!1),this.foxbox.services.off("services-changed",this.updateServiceList),this.foxbox.services.off("service-changed",this.updateServiceState)},t.prototype.updateServiceList=function(){var e=this;this.foxbox.services.getAll().then(function(t){return e.setState({services:t})})["catch"](function(e){console.error("Could not update service list: %o",e)})},t.prototype.updateServiceState=function(e){var t=this.state.services.findIndex(function(t){return t.id===e.id}),n=this.state.services;n[t]=e,this.setState({services:n})},t.prototype.renderHeader=function(){return e.prototype.renderHeader.call(this,"My Home")},t.prototype.renderBody=function(){return i("div",{className:"app-view__fill-body"},void 0,i("h2",{},void 0,"General"),i(g,{services:this.state.services,foxbox:this.foxbox}))},t}(u),b=function(e){function i(){return o(this,i),a(this,e.apply(this,arguments))}return s(i,e),i.prototype.main=function(){n.render(t.createElement(m,{foxbox:this.foxbox}),this.mountNode)},i}(e.Controller),y=function(e){function n(t){o(this,n);var i=a(this,e.call(this,t));return i.state={hasPreview:!1,hasPreviousSnapshot:!1},i.foxbox=t.foxbox,i.service=t.service,i}return s(n,e),n.prototype.takeSnapshot=function(){var e=this;this.service.takeSnapshot().then(function(t){var n=e.refs.snapshotPreview.src,i={hasPreview:!0,hasPreviousSnapshot:!1};e.refs.snapshotPreview.src=URL.createObjectURL(t),n&&(i.hasPreviousSnapshot=!0,e.refs.previousSnapshot.src&&URL.revokeObjectURL(e.refs.previousSnapshot.src),e.refs.previousSnapshot.src=n),e.setState(i)})["catch"](function(e){console.error("Error occurred while making a snapshot: ",e)})},n.prototype.render=function(){var e="app-view__fill-body camera-controls";return this.state.hasPreview&&(e+=" camera-controls--has-preview"),this.state.hasPreviousSnapshot&&(e+=" camera-controls--has-previous-snapshot"),i("div",{className:e},void 0,t.createElement("img",{ref:"snapshotPreview",alt:"Snapshot preview",className:"camera-controls__preview"}),i("div",{className:"camera-controls__empty-preview"},void 0,i("p",{},void 0,"Preview is not available."),i("p",{},void 0,"Touch button to take a snapshot!")),i("section",{className:"camera-controls__snapshot-tools"},void 0,i("button",{className:"camera-controls__snapshot-btn",type:"button",title:"Take a snapshot",onClick:this.takeSnapshot.bind(this)},void 0),t.createElement("img",{ref:"previousSnapshot",className:"camera-controls__previous-snapshot"})))},n}(t.Component),S=function(e){function t(n){o(this,t);var i=a(this,e.call(this,n));return i.state={name:n.service.name},i.foxbox=n.foxbox,i.service=n.service,i.onServiceStateChanged=i.onServiceStateChanged.bind(i),i}return s(t,e),t.prototype.componentDidMount=function(){this.foxbox.services.on("service-changed",this.onServiceStateChanged)},t.prototype.componentWillUnmount=function(){this.foxbox.services.off("service-changed",this.onServiceStateChanged)},t.prototype.onServiceStateChanged=function(e){e.id===this.service.id&&(this.service=e,this.setState({name:e.name}))},t.prototype.render=function(){return i("div",{className:"app-view__fill-body default-service__body"},void 0,i("p",{className:"default-service__notice"},void 0,"Oops, there are no settings available for this service."))},t}(t.Component),k=function(e){function t(n){o(this,t);var i=a(this,e.call(this,n));return i.state={name:n.service.name},i.foxbox=n.foxbox,i.service=n.service,i.onServiceStateChanged=i.onServiceStateChanged.bind(i),i}return s(t,e),t.prototype.componentDidMount=function(){this.foxbox.services.on("service-changed",this.onServiceStateChanged)},t.prototype.componentWillUnmount=function(){this.foxbox.services.off("service-changed",this.onServiceStateChanged)},t.prototype.onServiceStateChanged=function(e){e.id===this.service.id&&(this.service=e,this.setState({name:e.name}))},t.prototype.render=function(){return i("div",{className:"app-view__fill-body default-service__body"},void 0,i("p",{className:"default-service__notice"},void 0,"Oops, there are no settings available for this service."))},t}(t.Component),w=function(e){function t(n){o(this,t);var i=a(this,e.call(this,n));return i.state={service:null},i.foxbox=n.foxbox,i}return s(t,e),t.prototype.componentDidMount=function(){var e=this;this.foxbox.services.get(this.props.id).then(function(t){e.setState({service:t})})["catch"](function(e){console.error("Error occurred while retrieving service: ",e)})},t.prototype.renderHeader=function(){if(!this.state.service)return e.prototype.renderHeader.call(this,"Unknown Service");var t=this.state.service.name?this.state.service.name:"Unknown Service";return i("header",{className:"app-view__header"},void 0,i("h1",{},void 0,t),i("a",{href:`#services/${this.state.service.id}/tags`,title:"Edit tags",className:"service__edit-tags-link"},void 0,i("img",{className:"app-view__action-icon",src:"css/icons/tag.svg",alt:"Edit tags"})))},t.prototype.renderBody=function(){if(!this.state.service)return null;switch(this.state.service.type){case"ip-camera":return i(y,{service:this.state.service,foxbox:this.foxbox});case"light":return i(S,{service:this.state.service,foxbox:this.foxbox});default:return i(k,{service:this.state.service,foxbox:this.foxbox})}},t}(u);w.propTypes={foxbox:t.PropTypes.object.isRequired,id:t.PropTypes.string.isRequired};var x=function(e){function i(){return o(this,i),a(this,e.apply(this,arguments))}return s(i,e),i.prototype.main=function(e){n.render(t.createElement(w,{id:e,foxbox:this.foxbox}),this.mountNode)},i}(e.Controller),_=function(e){function t(){return o(this,t),a(this,e.apply(this,arguments))}return s(t,e),t.prototype.render=function(){var e=this,t=this.props.tags.map(function(t){return i("li",{className:"tag-list__item"},t,t,i("button",{className:"tag-list__item-remove",type:"button",onClick:e.props.onRemoveTag.bind(null,t),title:"Remove tag"}))});return i("ul",{className:"tag-list"},void 0,t)},t}(t.Component),O=function(e){function t(n){o(this,t);var i=a(this,e.call(this,n));return i.state={service:null,tags:[]},i.foxbox=n.foxbox,i.onServiceStateChanged=i.onServiceStateChanged.bind(i),i}return s(t,e),t.prototype.componentDidMount=function(){var e=this;this.foxbox.services.get(this.props.id).then(function(t){e.setState({service:t,tags:t.getTags()})})["catch"](function(e){console.error("Error occurred while retrieving service: ",e)}),this.foxbox.services.on("service-changed",this.onServiceStateChanged)},t.prototype.componentWillUnmount=function(){this.foxbox.services.off("service-changed",this.onServiceStateChanged)},t.prototype.onServiceStateChanged=function(e){e.id===this.props.id&&this.setState({service:e,tags:e.getTags()})},t.prototype.onAddTag=function(){var e=this,t=this.state.service;if(t){var n=(prompt("Enter new tag name")||"").trim();n&&(t.addTag(n)["catch"](function(i){console.error(`Could not add the tag "${n}": %o`,i),e.setState({tags:t.getTags()})}),this.setState({tags:t.getTags()}))}},t.prototype.onRemoveTag=function(e){var t=this,n=this.state.service;n.removeTag(e)["catch"](function(i){console.error(`Could not remove the tag "${e}": %o`,i),t.setState({tags:n.getTags()})}),this.setState({tags:n.getTags()})},t.prototype.renderHeader=function(){var t=this.state.service;return e.prototype.renderHeader.call(this,t&&t.name?t.name:"Unknown Service")},t.prototype.renderBody=function(){return i("div",{className:"app-view__fill-body"},void 0,i("h2",{},void 0,"Tags"),i(_,{tags:this.state.tags,onRemoveTag:this.onRemoveTag.bind(this)}),i("button",{className:"add-tag-button",type:"button",onClick:this.onAddTag.bind(this)},void 0,"Create a new tag"))},t}(u);O.propTypes={foxbox:t.PropTypes.object.isRequired,id:t.PropTypes.string.isRequired};var L=function(e){function i(){return o(this,i),a(this,e.apply(this,arguments))}return s(i,e),i.prototype.main=function(e){n.render(t.createElement(O,{id:e,foxbox:this.foxbox}),this.mountNode)},i}(e.Controller),N=function(e){function t(n){o(this,t);var i=a(this,e.call(this,n));return i.state={enabled:n.theme.enabled},i.foxbox=n.foxbox,i.handleOnChange=i.handleOnChange.bind(i),i.handleOnDelete=i.handleOnDelete.bind(i),i}return s(t,e),t.prototype.handleOnChange=function(e){var t=this,n=e.target.checked;this.setState({enabled:n}),this.foxbox.recipes.toggle(this.props.theme,n)["catch"](function(e){t.setState({enabled:!n}),console.error(e)})},t.prototype.handleOnDelete=function(){var e=this;this.foxbox.recipes.remove(this.props.theme).then(function(){e.props.update()})["catch"](console.error.bind(console))},t.prototype.render=function(){var e="themes-list__item";return this.state.enabled||(e+=" themes-list__item--deactivated"),i("li",{className:e},void 0,i("input",{className:"themes-list__toggle",type:"checkbox",checked:this.state.enabled,onChange:this.handleOnChange}),i("span",{className:"themes-list__name"},void 0,this.props.theme.label),i("button",{className:"themes-list__remove",onClick:this.handleOnDelete}))},t}(t.Component),C=function(e){function t(n){o(this,t);var i=a(this,e.call(this,n));return i.state={themes:[]},i.foxbox=n.foxbox,i.update=i.update.bind(i),i}return s(t,e),t.prototype.componentDidMount=function(){this.update()},t.prototype.update=function(){var e=this;this.foxbox.recipes.getAll().then(function(t){e.setState({themes:t})})["catch"](console.error.bind(console))},t.prototype.renderHeader=function(){return i("header",{className:"app-view__header"},void 0,i("h1",{},void 0,"Recipes"),i("a",{href:"#themes/new",className:"themes__new-link"},void 0,i("img",{className:"app-view__action-icon",src:"css/icons/plus.svg",alt:"Add a recipe"})))},t.prototype.renderBody=function(){var e=this,t=this.state.themes.map(function(t){return i(N,{theme:t,update:e.update,foxbox:e.foxbox},t.id)});return i("div",{className:"app-view__fill-body themes"},void 0,i("ul",{className:"themes-list"},void 0,t))},t}(u),E=function(e){function t(n){o(this,t);var i=a(this,e.call(this,n));return i.state={getters:[],setters:[],selectedGetterIndex:-1,selectedGetterValueIndex:-1,selectedSetterIndex:-1,selectedSetterValueIndex:-1},i.foxbox=n.foxbox,i.updateServices=i.updateServices.bind(i),i.onGetterSelected=i.onGetterSelected.bind(i),i.onGetterValueSelected=i.onGetterValueSelected.bind(i),i.onSetterSelected=i.onSetterSelected.bind(i),i.onSetterValueSelected=i.onSetterValueSelected.bind(i),i.onSaveRecipe=i.onSaveRecipe.bind(i),i}return s(t,e),t.prototype.componentDidMount=function(){var e=this;Promise.all([this.foxbox.recipes.getGetters(),this.foxbox.recipes.getSetters()]).then(function(t){return e.updateServices(t)})["catch"](console.error.bind(console))},t.prototype.updateServices=function(){var e=arguments.length<=0||void 0===arguments[0]?[[],[]]:arguments[0],t=c(e,2),n=t[0],i=t[1];this.setState({getters:n,setters:i})},t.prototype.onGetterSelected=function(e){var t=-1;e.target.value&&(t=Number(e.target.value)),this.setState({selectedGetterIndex:t,selectedGetterValueIndex:-1,selectedSetterIndex:-1,selectedSetterValueIndex:-1})},t.prototype.onGetterValueSelected=function(e){var t=-1;e.target.value&&(t=Number(e.target.value)),this.setState({selectedGetterValueIndex:t,selectedSetterIndex:-1,selectedSetterValueIndex:-1})},t.prototype.onSetterSelected=function(e){var t=-1;e.target.value&&(t=Number(e.target.value)),this.setState({selectedSetterIndex:t,selectedSetterValueIndex:-1})},t.prototype.onSetterValueSelected=function(e){var t=-1;e.target.value&&(t=Number(e.target.value)),this.setState({selectedSetterValueIndex:t})},t.prototype.onSaveRecipe=function(){if(!(this.state.selectedSetterValueIndex<0)){var e=this.state.getters[this.state.selectedGetterIndex],t=e.options[this.state.selectedGetterValueIndex],n=this.state.setters[this.state.selectedSetterIndex],i=n.options[this.state.selectedSetterValueIndex],o=`${e.name} ${t.label}, `+`${n.name} ${i.label}.`;this.foxbox.recipes.add({name:o,getter:e,getterValue:t,setter:n,setterValue:i}).then(function(){location.hash="#themes"})["catch"](function(e){console.log("Error occurred while saving recipe: ",e)})}},t.prototype.renderHeader=function(){var e="app-view__action";return null===this.state.setter&&(e+=" app-view__action--disabled"),i("header",{className:"app-view__header"},void 0,i("a",{href:"#themes",className:"app-view__action"},void 0,"Cancel"),i("h1",{},void 0,"New Recipe"),i("button",{className:e,onClick:this.onSaveRecipe},void 0,"Done"))},t.prototype.renderBody=function(){var e="new-theme__header";return this.state.selectedGetterValueIndex<0&&(e+=" new-theme__header--hidden"),i("div",{className:"app-view__fill-body new-theme"},void 0,i("h2",{className:"new-theme__header"},void 0,"If"),this.renderGetterSelector(),this.renderGetterValueSelector(),i("h2",{className:e},void 0,"Do"),this.renderSetterSelector(),this.renderSetterValueSelector())},t.prototype.renderGetterSelector=function(){var e=this,t="new-theme__select";this.state.selectedGetterIndex>=0&&(t+=" new-theme__select--selected");var n=this.state.getters.map(function(t,n){return i("option",{value:n},n,e.getChannelName(t))});return i("select",{value:this.state.selectedGetterIndex,onChange:this.onGetterSelected,className:t},void 0,i("option",{value:""},void 0,"Select a device"),n)},t.prototype.renderGetterValueSelector=function(){if(this.state.selectedGetterIndex<0)return i("select",{className:"new-theme__select new-theme__select--hidden"},void 0);var e="new-theme__select";this.state.selectedGetterValueIndex>=0&&(e+=" new-theme__select--selected");var t=this.state.getters[this.state.selectedGetterIndex].options,n=t.map(function(e,t){return i("option",{value:t},t,e.label)});return i("select",{value:this.state.selectedGetterValueIndex,onChange:this.onGetterValueSelected,className:e},void 0,i("option",{value:""},void 0,"Select a property"),n)},t.prototype.renderSetterSelector=function(){var e=this;if(this.state.selectedGetterValueIndex<0)return i("select",{className:"new-theme__select new-theme__select--hidden"},void 0);var t="new-theme__select";this.state.selectedSetterIndex>=0&&(t+=" new-theme__select--selected");var n=this.state.setters.map(function(t,n){return i("option",{value:n},n,e.getChannelName(t))});return i("select",{value:this.state.selectedSetterIndex,onChange:this.onSetterSelected,className:t},void 0,i("option",{value:""},void 0,"Select a device"),n)},t.prototype.renderSetterValueSelector=function(){if(this.state.selectedSetterIndex<0)return i("select",{className:"new-theme__select new-theme__select--hidden"},void 0);var e="new-theme__select";null!==this.state.setter&&(e+=" new-theme__select--selected");var t=this.state.setters[this.state.selectedSetterIndex].options,n=t.map(function(e,t){return i("option",{value:t},t,e.label)});return i("select",{value:this.state.selectedSetterValueIndex,onChange:this.onSetterValueSelected,className:e},void 0,i("option",{value:""},void 0,"Select a property"),n)},t.prototype.getChannelName=function(e){var t=e.tags.join(", ");return t?`${e.name} (${t})`:e.name},t}(u),I=function(e){function i(){return o(this,i),a(this,e.apply(this,arguments))}return s(i,e),i.prototype.main=function(){var e=arguments.length<=0||void 0===arguments[0]?"list":arguments[0],i={foxbox:this.foxbox};switch(e){case"list":n.render(t.createElement(C,i),this.mountNode);break;case"new":n.render(t.createElement(E,i),this.mountNode)}},i}(e.Controller),T=function(e){function n(t){o(this,n);var i=a(this,e.call(this,t));return i.state={service:null,hasPreview:!1},i.foxbox=t.foxbox,i}return s(n,e),n.prototype.componentDidMount=function(){var e=this;this.foxbox.services.get(this.props.id).then(function(t){return e.setState({service:t}),t.getLatestImage()}).then(function(t){e.refs.snapshotPreview.src=URL.createObjectURL(t),e.setState({hasPreview:!0})})["catch"](function(t){console.error("Error occurred while retrieving latest image for camera (id=%s): ",e.props.id,t)})},n.prototype.renderHeader=function(){return e.prototype.renderHeader.call(this,this.state.service&&this.state.service.name?this.state.service.name:"Unknown Service")},n.prototype.renderBody=function(){var e="app-view__fill-body camera-controls";return this.state.hasPreview&&(e+=" camera-controls--has-preview"),i("div",{className:e},void 0,t.createElement("img",{ref:"snapshotPreview",style:{flexGrow:0},alt:"Snapshot preview",className:"camera-controls__preview"}),i("div",{className:"camera-controls__empty-preview"},void 0,i("p",{},void 0,"Preview is being loaded."),i("p",{},void 0,"Wait a moment please!")))},n}(u);T.propTypes={foxbox:t.PropTypes.object.isRequired,id:t.PropTypes.string.isRequired};var P=function(e){function i(){return o(this,i),a(this,e.apply(this,arguments))}return s(i,e),i.prototype.main=function(e,i){switch(e){case"camera-latest-image":n.render(t.createElement(T,{id:i,foxbox:this.foxbox}),this.mountNode);break;default:console.error('Unknown development view path "%s"',e)}},i}(e.Controller),j=function(e){if(!e||"string"!=typeof e)throw new Error("Event name should be a valid non-empty string!")},G=function(e){if("function"!=typeof e)throw new Error("Handler should be a function!")},D=function(e,t){if(e&&e.indexOf(t)<0)throw new Error(`Event "${t}" is not allowed!`)},R=Object.freeze({allowedEvents:Symbol("allowedEvents"),listeners:Symbol("listeners")}),V=function(){function e(t){if(o(this,e),"undefined"!=typeof t&&!Array.isArray(t))throw new Error("Allowed events should be a valid array of strings!");this[R.listeners]=new Map,this[R.allowedEvents]=t}return e.prototype.on=function(e,t){j(e),D(this[R.allowedEvents],e),G(t);var n=this[R.listeners].get(e);n||(n=new Set,this[R.listeners].set(e,n)),n.add(t)},e.prototype.once=function t(e,n){var i=this;G(n);var t=function(o){i.off(e,t),n.call(i,o)};this.on(e,t)},e.prototype.off=function(e,t){j(e),D(this[R.allowedEvents],e),G(t);var n=this[R.listeners].get(e);n&&(n["delete"](t),n.size||this[R.listeners]["delete"](e))},e.prototype.offAll=function(e){if("undefined"==typeof e)return void this[R.listeners].clear();j(e),D(this[R.allowedEvents],e);var t=this[R.listeners].get(e);t&&(t.clear(),this[R.listeners]["delete"](e))},e.prototype.emit=function(e,t){var n=this;j(e),D(this[R.allowedEvents],e);var i=this[R.listeners].get(e);i&&i.forEach(function(e){try{e.call(n,t)}catch(i){console.error(i)}})},e.prototype.hasListeners=function(e){return j(e),D(this[R.allowedEvents],e),this[R.listeners].has(e)},e}(),U="foxbox-",A=1,B="auth",H=/([A-Z])/g,z=Object.freeze({values:Symbol("values"),storage:Symbol("storage"),updateSetting:Symbol("updateSetting"),stringToSettingTypedValue:Symbol("stringToSettingTypedValue"),getDefaultSettingValue:Symbol("getDefaultSettingValue"),onStorage:Symbol("onStorage")}),M=Object.freeze({CONFIGURED:Object.freeze({key:"configured",type:"boolean"}),SKIP_DISCOVERY:Object.freeze({key:"skipDiscovery",type:"boolean"}),SERVICE_POLLING_ENABLED:Object.freeze({key:"servicePollingEnabled",type:"boolean",defaultValue:!0}),SERVICE_POLLING_INTERVAL:Object.freeze({key:"servicePollingInterval",type:"number",defaultValue:2e3}),WATCH_INTERVAL:Object.freeze({key:"watchInterval",type:"number",defaultValue:3e3}),ONLINE_CHECKING_INTERVAL:Object.freeze({key:"onlineCheckingInterval",type:"number",defaultValue:5e3}),ONLINE_CHECKING_LONG_INTERVAL:Object.freeze({key:"onlineCheckingLongInterval",type:"number",defaultValue:3e5}),LOCAL_ORIGIN:Object.freeze({key:"localOrigin"}),TUNNEL_ORIGIN:Object.freeze({key:"tunnelOrigin"}),CLIENT:Object.freeze({key:"client"}),SESSION:Object.freeze({key:"session"}),PUSH_ENDPOINT:Object.freeze({key:"pushEndpoint"}),PUSH_PUB_KEY:Object.freeze({key:"pushPubKey"}),PUSH_AUTH:Object.freeze({key:"pushAuth"}),REGISTRATION_SERVICE:Object.freeze({key:"registrationService",defaultValue:"https://knilxof.org:4443/ping"})}),W=function(e){function t(){var n=arguments.length<=0||void 0===arguments[0]?localStorage:arguments[0];o(this,t);var i=a(this,e.call(this));return i[z.storage]=n||{getItem:function(){return null},setItem:function(){},removeItem:function(){},clear:function(){}},i[z.values]=new Map,Object.keys(M).forEach(function(e){var t=M[e],n=i[z.storage].getItem(`${U}${t.key}`);i[z.values].set(t,i[z.stringToSettingTypedValue](t,n))}),window.addEventListener("storage",i[z.onStorage].bind(i)),Object.seal(i),i}return s(t,e),t.prototype.clear=function(){var e=this;return new Promise(function(t){Object.keys(M).forEach(function(t){var n=M[t];e[z.updateSetting](n,e[z.getDefaultSettingValue](n))}),t()})},t.prototype[z.updateSetting]=function(e,t){var n=this[z.values].get(e);n!==t&&(this[z.values].set(e,t),t!==this[z.getDefaultSettingValue](e)?this[z.storage].setItem(`${U}${e.key}`,t):this[z.storage].removeItem(`${U}${e.key}`),this.emit(e.key.replace(H,function(e){return`-${e.toLowerCase()}`}),t))},t.prototype[z.stringToSettingTypedValue]=function(e,t){
return null===t?this[z.getDefaultSettingValue](e):"boolean"===e.type?"true"===t:"number"===e.type?Number(t):t},t.prototype[z.getDefaultSettingValue]=function(e){return void 0!==e.defaultValue?e.defaultValue:"boolean"!==e.type&&("number"===e.type?0:null)},t.prototype[z.onStorage]=function(e){if(e.key.startsWith(U)){var t=e.key.substring(U.length),n=Object.keys(M).find(function(e){return M[e].key===t});if(!n)return void console.warn(`Changed unknown storage entry with app specific prefix: ${e.key}`);var i=M[n];this[z.updateSetting](i,this[z.stringToSettingTypedValue](i,e.newValue))}},r(t,[{key:"configured",get:function(){return this[z.values].get(M.CONFIGURED)},set:function(e){this[z.updateSetting](M.CONFIGURED,e)}},{key:"localOrigin",get:function(){return this[z.values].get(M.LOCAL_ORIGIN)},set:function(e){this[z.updateSetting](M.LOCAL_ORIGIN,e?new URL(e).origin:null)}},{key:"tunnelOrigin",get:function(){return this[z.values].get(M.TUNNEL_ORIGIN)},set:function(e){this[z.updateSetting](M.TUNNEL_ORIGIN,e?new URL(e).origin:null)}},{key:"client",get:function(){return this[z.values].get(M.CLIENT)},set:function(e){this[z.updateSetting](M.CLIENT,e?String(e):null)}},{key:"session",get:function(){return this[z.values].get(M.SESSION)},set:function(e){this[z.updateSetting](M.SESSION,e)}},{key:"skipDiscovery",get:function(){return this[z.values].get(M.SKIP_DISCOVERY)},set:function(e){this[z.updateSetting](M.SKIP_DISCOVERY,e)}},{key:"servicePollingEnabled",get:function(){return this[z.values].get(M.SERVICE_POLLING_ENABLED)},set:function(e){this[z.updateSetting](M.SERVICE_POLLING_ENABLED,e)}},{key:"pushEndpoint",get:function(){return this[z.values].get(M.PUSH_ENDPOINT)},set:function(e){this[z.updateSetting](M.PUSH_ENDPOINT,e)}},{key:"pushPubKey",get:function(){return this[z.values].get(M.PUSH_PUB_KEY)},set:function(e){this[z.updateSetting](M.PUSH_PUB_KEY,e)}},{key:"pushAuth",get:function(){return this[z.values].get(M.PUSH_AUTH)},set:function(e){this[z.updateSetting](M.PUSH_AUTH,e)}},{key:"registrationService",get:function(){return this[z.values].get(M.REGISTRATION_SERVICE)}},{key:"servicePollingInterval",get:function(){return this[z.values].get(M.SERVICE_POLLING_INTERVAL)}},{key:"onlineCheckingInterval",get:function(){return this[z.values].get(M.ONLINE_CHECKING_INTERVAL)}},{key:"onlineCheckingLongInterval",get:function(){return this[z.values].get(M.ONLINE_CHECKING_LONG_INTERVAL)}},{key:"watchInterval",get:function(){return this[z.values].get(M.WATCH_INTERVAL)}},{key:"queryStringAuthTokenName",get:function(){return B}},{key:"apiVersion",get:function(){return A}}]),t}(V),F=Object.freeze({promise:Symbol("promise"),resolve:Symbol("resolve"),reject:Symbol("reject")}),q=function(){function e(){var t=this;o(this,e),this[F.promise]=new Promise(function(e,n){t[F.resolve]=e,t[F.reject]=n}),Object.freeze(this)}return e.prototype.resolve=function(e){this[F.resolve](e)},e.prototype.reject=function(e){this[F.reject](e)},r(e,[{key:"promise",get:function(){return this[F.promise]}}]),e}(),J=Object.freeze({db:Symbol("db"),initializationStarted:Symbol("initializationStarted"),upgradeSchema:Symbol("upgradeSchema"),getAll:Symbol("getAll"),getById:Symbol("getById"),set:Symbol("set"),remove:Symbol("remove"),clearDb:Symbol("clearDb")}),K="foxbox-db",Y=1,$="services",Z=function(){function e(){o(this,e),this[J.db]=new q,this[J.initializationStarted]=!1,Object.seal(this)}return e.prototype.init=function(){var e=this,t=this[J.db].promise.then(function(){});if(this[J.initializationStarted])return t;try{var n=indexedDB.open(K,Y);n.onupgradeneeded=this[J.upgradeSchema],n.onsuccess=function(t){return e[J.db].resolve(t.target.result)},n.onerror=function(t){return e[J.db].reject(t)}}catch(i){this[J.db].reject(i)}return t["catch"](function(e){throw console.error("Error opening database: %o",e),e})},e.prototype.clear=function(){var e=this;return this[J.db].promise.then(function(e){return e.close(),new Promise(function(e,t){var n=indexedDB.deleteDatabase(K);n.onsuccess=e,n.onerror=t,n.onblocked=t})}).then(function(){e[J.db]=new q,e[J.initializationStarted]=!1})},e.prototype.getServices=function(){return this[J.getAll]($)},e.prototype.getService=function(e){return this[J.getById]($,e)},e.prototype.setService=function(e){return this[J.set]($,e)},e.prototype.deleteService=function(e){return this[J.remove]($,e.id)},e.prototype.clearServices=function(){return this[J.clearDb]($)},e.prototype[J.upgradeSchema]=function(e){var t=e.target.result,n=e.oldVersion;if(1>n){var i=t.createObjectStore($,{keyPath:"id"});i.createIndex("id","id",{unique:!0})}},e.prototype[J.getAll]=function(e){return this[J.db].promise.then(function(t){return new Promise(function(n,i){var o=t.transaction([e],"readonly"),r=[];o.onerror=i,o.oncomplete=function(){return n(r)},o.objectStore(e).openCursor().onsuccess=function(e){var t=e.target.result;t&&(r.push(t.value),t["continue"]())}})})},e.prototype[J.getById]=function(e,t){return this[J.db].promise.then(function(n){return new Promise(function(i,o){var r=n.transaction([e],"readonly");r.onerror=o,r.objectStore(e).get(t).onsuccess=function(e){i(e.target.result)}})})},e.prototype[J.set]=function(e,t){return this[J.db].promise.then(function(n){return new Promise(function(i,o){var r=n.transaction([e],"readwrite");r.oncomplete=i,r.onerror=o;try{r.objectStore(e).put(t)}catch(s){console.error(`Error putting data in ${K}:`,s),i()}})})},e.prototype[J.remove]=function(e,t){return this[J.db].promise.then(function(n){return new Promise(function(i,o){var r=n.transaction([e],"readwrite");r.oncomplete=i,r.onerror=o;try{r.objectStore(e)["delete"](t)}catch(s){console.error(`Error deleting data from ${K}:`,s),i()}})})},e.prototype[J.clearDb]=function(e){return this[J.db].promise.then(function(t){return new Promise(function(n,i){var o=t.transaction([e],"readwrite");o.oncomplete=n,o.onerror=i,o.objectStore(e).clear()})})},e}(),Q=Object.freeze({started:Symbol("started"),nextTickHandle:Symbol("nextTickHandle"),scheduleTick:Symbol("scheduleTick"),onTick:Symbol("onTick")}),X=function(){function e(t){o(this,e),this.interval=t,this[Q.started]=!1,this[Q.nextTickHandle]=null,this[Q.onTick]=null,Object.seal(this)}return e.prototype.start=function(e){if(this[Q.started])return void console.warn("Timer has been already started.");if("function"!=typeof e)throw new Error("onTick handler should be a valid function.");this[Q.started]=!0,this[Q.onTick]=e,this[Q.scheduleTick]()},e.prototype.stop=function(){return this[Q.started]?(this[Q.started]=!1,clearTimeout(this[Q.nextTickHandle]),this[Q.nextTickHandle]=null,void(this[Q.onTick]=null)):void console.warn("Timer has not been started yet.")},e.prototype[Q.scheduleTick]=function(){var e=this;this[Q.started]&&!this[Q.nextTickHandle]&&(this[Q.nextTickHandle]=setTimeout(function(){new Promise(function(t){return t(e[Q.onTick]())})["catch"](function(e){console.error("onTick handler failed, scheduling next tick anyway: %o",e)}).then(function(){e[Q.nextTickHandle]=null,e[Q.scheduleTick]()})},this.interval))},r(e,[{key:"started",get:function(){return this[Q.started]}}]),e}(),ee=Object.freeze({origin:Symbol("origin"),online:Symbol("online"),lastSeenOnline:Symbol("lastSeenOnline"),pingTimer:Symbol("pingTimer"),ping:Symbol("ping")}),te=function(e){function t(n){o(this,t);var i=a(this,e.call(this,["online"]));if(!n)throw new Error("Origin should be valid non-empty string.");return i[ee.ping]=i[ee.ping].bind(i),i[ee.origin]=n,i[ee.online]=!1,i[ee.lastSeenOnline]=0,i[ee.pingTimer]=new X(Number.POSITIVE_INFINITY),Object.seal(i),i}return s(t,e),t.prototype.seenOnline=function(){this[ee.online]=!0,this[ee.lastSeenOnline]=Date.now()},t.prototype.enableAutoPing=function(e){if("number"!=typeof e||0>e)throw new Error("Interval should valid positive number.");this[ee.pingTimer].interval=e,this[ee.pingTimer].started||this[ee.pingTimer].start(this[ee.ping])},t.prototype.disableAutoPing=function(){this[ee.pingTimer].started&&this[ee.pingTimer].stop()},t.prototype.ping=function(){return this[ee.ping](!0)},t.prototype[ee.ping]=function(e){var t=this,n=Date.now()-this[ee.lastSeenOnline]<this[ee.pingTimer].interval;return e||!n&&!document.hidden?fetch(`${this[ee.origin]}/ping`,{cache:"no-store"}).then(function(e){return e.ok},function(e){return console.error("Error occurred while pinging box: %o",e),!1}).then(function(e){if(e&&(t[ee.lastSeenOnline]=Date.now()),t[ee.online]!==e)return t[ee.online]=e,t.emit("online",e),e}):Promise.resolve()},r(t,[{key:"origin",get:function(){return this[ee.origin]}},{key:"online",get:function(){return this[ee.online]}}]),t}(V),ne=Object.freeze({settings:Symbol("settings"),localLink:Symbol("localLink"),tunnelLink:Symbol("tunnelLink"),linkPingInterval:Symbol("linkPingInterval"),online:Symbol("online"),fetch:Symbol("fetch"),pingLinks:Symbol("pingLinks"),updateLink:Symbol("updateLink"),onLinkOnlineChange:Symbol("onLinkOnlineChange"),onLinkOriginChange:Symbol("onLinkOriginChange")}),ie=function(e){function t(n){o(this,t);var i=a(this,e.call(this,["online"]));return i[ne.settings]=n,i[ne.localLink]=null,i[ne.tunnelLink]=null,i[ne.linkPingInterval]=null,i[ne.online]=!1,i[ne.pingLinks]=i[ne.pingLinks].bind(i),i[ne.onLinkOnlineChange]=i[ne.onLinkOnlineChange].bind(i),i[ne.onLinkOriginChange]=i[ne.onLinkOriginChange].bind(i),Object.seal(i),i}return s(t,e),t.prototype.init=function(){return window.addEventListener("online",this[ne.pingLinks]),window.addEventListener("offline",this[ne.pingLinks]),"connection"in navigator&&"onchange"in navigator.connection?(navigator.connection.addEventListener("change",this[ne.pingLinks]),this[ne.linkPingInterval]=this[ne.settings].onlineCheckingLongInterval):this[ne.linkPingInterval]=this[ne.settings].onlineCheckingInterval,this[ne.settings].on("local-origin",this[ne.onLinkOriginChange]),this[ne.settings].on("tunnel-origin",this[ne.onLinkOriginChange]),this[ne.onLinkOriginChange](),Promise.resolve()},t.prototype.fetchJSON=function(e){var t=arguments.length<=1||void 0===arguments[1]?"GET":arguments[1],n=arguments.length<=2||void 0===arguments[2]?void 0:arguments[2];return this[ne.fetch](e,"application/json",t,n).then(function(e){return e.json()})},t.prototype.fetchBlob=function(e,t,n,i){return this[ne.fetch](e,t,n,i).then(function(e){return e.blob()})},t.prototype[ne.fetch]=function(e,t){var n=this,i=arguments.length<=2||void 0===arguments[2]?"GET":arguments[2],o=arguments.length<=3||void 0===arguments[3]?void 0:arguments[3];i=i.toUpperCase();var r={method:i,headers:{Accept:t},cache:"no-store"};return"POST"!==i&&"PUT"!==i&&"DELETE"!==i||(r.headers["Content-Type"]="application/json;charset=UTF-8"),this[ne.settings].session&&(r.headers.Authorization=`Bearer ${this[ne.settings].session}`),void 0!==o&&(r.body=JSON.stringify(o)),fetch(e,r).then(function(t){if(!t.ok)throw new TypeError(`The response returned a ${t.status} HTTP status code.`);var i=new URL(e).origin;return n[ne.localLink]&&n[ne.localLink].origin===i?n[ne.localLink].seenOnline():n[ne.tunnelLink]&&n[ne.tunnelLink].origin===i&&n[ne.tunnelLink].seenOnline(),t})["catch"](function(e){throw console.error("Error occurred while fetching content: ",e),e})},t.prototype[ne.pingLinks]=function(){this[ne.localLink]&&this[ne.localLink].ping(),this[ne.tunnelLink]&&this[ne.tunnelLink].ping()},t.prototype[ne.updateLink]=function(e,t){var n=this[e];!t&&!n||n&&n.origin===t||(n&&(n.off("online",this[ne.onLinkOnlineChange]),n.disableAutoPing(),this[e]=null),t&&(this[e]=new te(t),this[e].enableAutoPing(this[ne.linkPingInterval]),this[e].on("online",this[ne.onLinkOnlineChange]),this[e].ping()),this[ne.onLinkOnlineChange]())},t.prototype[ne.onLinkOriginChange]=function(){this[ne.updateLink](ne.localLink,this.localOrigin),this[ne.updateLink](ne.tunnelLink,this.tunnelOrigin)},t.prototype[ne.onLinkOnlineChange]=function(){var e=!!this[ne.localLink]&&this[ne.localLink].online||!!this[ne.tunnelLink]&&this[ne.tunnelLink].online;this[ne.online]!==e&&(this[ne.online]=e,this.emit("online",e))},r(t,[{key:"origin",get:function(){if(this[ne.localLink])return this[ne.localLink].origin;if(this[ne.tunnelLink])return this[ne.tunnelLink].origin;throw new Error("Origin is not accessible")}},{key:"localOrigin",get:function(){return this[ne.settings].localOrigin}},{key:"tunnelOrigin",get:function(){return this[ne.settings].tunnelOrigin}},{key:"online",get:function(){return this[ne.online]}}]),t}(V),oe=Object.freeze({api:Symbol("api"),service:Symbol("service")}),re=function(){function e(t){if(o(this,e),!t)throw new Error("Service is required!");this[oe.service]=t}return r(e,[{key:"id",get:function(){return this[oe.service].id}},{key:"label",get:function(){return this[oe.service].source&&this[oe.service].source.name}},{key:"enabled",get:function(){return this[oe.service].status}}]),e}(),se=function(){function e(t){o(this,e),this[oe.api]=t,Object.seal(this)}return e.prototype.getAll=function(){var e=this;return this[oe.api].post("services",{channels:[{feature:"thinkerbell/rule-source"}]}).then(function(e){return e.map(function(e){return Object.keys(e.channels).reduce(function(t,n){var i=e.channels[n];switch(i.feature){case"thinkerbell/is-rule-enabled":t.enabled=n;break;case"thinkerbell/rule-source":t.getSource=n;break;case"thinkerbell/remove-rule-id":t.remove=n}return t},{id:e.id,getSource:null,enabled:null,remove:null,status:null,source:null})})}).then(function(t){var n=t.reduce(function(e,t){return e.enabledSelectors.push({id:t.enabled}),e.sourceSelectors.push({id:t.getSource}),e},{enabledSelectors:[],sourceSelectors:[]}),i=n.enabledSelectors,o=n.sourceSelectors;return Promise.all([e[oe.api].put("channels/get",i),e[oe.api].put("channels/get",o)]).then(function(e){var n=c(e,2),i=n[0],o=n[1];return t.map(function(e){var t=i[e.enabled],n=o[e.getSource];return t&&t.OnOff?e.status="On"===t.OnOff:(console.error("Error occurred while retrieving recipe (%s) status: ",e.id,t&&t.Error),e.status=!1),n&&n.String?e.source=JSON.parse(n.String):(console.error("Error occurred while retrieving recipe (%s) source: ",e.id,n&&n.Error),e.source=null),new re(e)})})})},e.prototype.getGetters=function(){var e=["clock/time-of-day-seconds","door/is-open","door/is-locked"];return this[oe.api].post("channels",e.map(function(e){return{feature:e,supports_fetch:!0}})).then(function(e){return e.map(function(e){var t=void 0,n=[];switch(e.feature){case"clock/time-of-day-seconds":t="Everyday",n.push.apply(n,[{label:"in the morning",value:{Geq:{Duration:28800}}},{label:"in the afternoon",value:{Geq:{Duration:50400}}},{label:"in the evening",value:{Geq:{Duration:64800}}}]);break;case"door/is-open":t="Motion Sensor",n.push({label:"detects motion",value:{Eq:{OpenClosed:"Open"}}});break;case"door/is-locked":t="Door",n.push({label:"is locked",value:{Eq:{DoorLocked:"Locked"}}},{label:"is unlocked",value:{Eq:{DoorLocked:"Unlocked"}}})}return{id:e.id,feature:e.feature,name:t||e.adapter,tags:e.tags,options:n}})})},e.prototype.getSetters=function(){var e=["speak/sentence","camera/store-snapshot","light/is-on","door/is-locked"];return this[oe.api].post("channels",e.map(function(e){return{feature:e,supports_send:!0}})).then(function(e){return e.map(function(e){var t=[],n=void 0;switch(e.feature){case"speak/sentence":n="say",t.push.apply(t,[{label:'"Good morning!"',value:{String:'"Good morning!"'}},{label:'"Good afternoon!"',value:{String:'"Good afternoon!"'}},{label:'"Good evening!"',value:{String:'"Good evening!"'}}]);break;case"camera/store-snapshot":n="camera",t.push.apply(t,[{label:"takes a picture",value:{Unit:null}},{label:"sends me a picture",value:[{destination:[{id:e.id}],feature:"camera/store-snapshot",value:{Unit:null}},{destination:[{feature:"webpush/notify-msg"}],feature:"webpush/notify-msg",value:{WebPushNotify:{message:JSON.stringify({message:"Your bedroom patio door has just been opened. Here is a picture of what I see.",action:`dev/camera-latest-image/${e.service}`}),resource:"res1"}}}]}]);break;case"light/is-on":n="light",t.push.apply(t,[{label:"gets turned on",value:{OnOff:"On"}},{label:"gets turned off",value:{OnOff:"Off"}}]);break;case"door/is-locked":n="door lock",t.push.apply(t,[{label:"locks the door",value:{DoorLocked:"Locked"}},{label:"unlocks the door",value:{DoorLocked:"Unlocked"}}])}return{id:e.id,feature:e.feature,name:n||e.adapter,tags:e.tags,options:t}})})},e.prototype.add=function(e){var t=e.name,n=e.getter,i=e.getterValue,o=e.setter,r=e.setterValue,s=void 0;Array.isArray(r.value)?s=r.value:"object"==typeof r.value?s=[{destination:[{id:o.id}],feature:o.feature,value:r.value}]:console.error("Setter doesn't have a supported format:",JSON.stringify(o));var a={name:t,rules:[{conditions:[{source:[{id:n.id}],feature:n.feature,range:i.value}],execute:s}]};return this[oe.api].put("channels/set",{select:{feature:"thinkerbell/add-rule"},value:{ThinkerbellRule:{name:t,source:JSON.stringify(a)}}})},e.prototype.remove=function(e){return this[oe.api].put("channels/set",{select:{id:e[oe.service].remove},value:null})},e.prototype.toggle=function(e){var t=arguments.length<=1||void 0===arguments[1]||arguments[1],n=t?"On":"Off";return this[oe.api].put("channels/set",{select:{id:e[oe.service].enabled},value:{OnOff:n}}).then(function(){e[oe.service].status=t})},e.prototype.createDemoRecipes=function(){var e=this;Promise.all([this.getGetters(),this.getSetters()]).then(function(t){var n=c(t,2),i=n[0],o=n[1],r=i.find(function(e){return"clock/time-of-day-seconds"===e.feature}),s=o.filter(function(e){return"light/is-on"===e.feature}),a=[{source:[{id:r.id}],feature:"clock/time-of-day-seconds",range:{Geq:{Duration:28800}}}],l=[].concat(s.map(function(e){return{destination:[{id:e.id}],feature:e.feature,value:{OnOff:"Off"}}}),[{destination:[{feature:"webpush/notify-msg"}],feature:"webpush/notify-msg",value:{WebPushNotify:{message:JSON.stringify({message:"Hello Alex, I've turned your kitchen lights off for you. Have a wonderful day!"}),resource:"res1"}}}]),u={name:"Turn off the lights when I leave for work.",rules:[{conditions:a,execute:l}]};return console.log("Recipe for the demo",u),e[oe.api].put("channels/set",{select:{feature:"thinkerbell/add-rule"},value:{ThinkerbellRule:{name,source:JSON.stringify(u)}}})}),this.createDoorLockDemoRecipe()},e.prototype.createDoorLockDemoRecipe=function(){var e=this;Promise.all([this.getGetters(),this.getSetters()]).then(function(t){var n=c(t,2),i=n[0],o=n[1],r=i.find(function(e){return"clock/time-of-day-seconds"===e.feature}),s=i.find(function(e){return"door/is-locked"===e.feature}),a=o.find(function(e){return"door/is-locked"===e.feature}),l=[{source:[{id:r.id}],feature:"clock/time-of-day-seconds",range:{Geq:{Duration:28800}}},{source:[{id:s.id}],feature:s.feature,range:{Eq:{DoorLocked:"Unlocked"}}}],u=[{destination:[{id:a.id}],feature:a.feature,value:{DoorLocked:"Locked"}},{destination:[{feature:"webpush/notify-msg"}],feature:"webpush/notify-msg",value:{WebPushNotify:{message:JSON.stringify({message:"Hello Alex, I've locked the door for you. Have a wonderful day!"}),resource:"res1"}}}],h={name:"Lock the door when I leave for work.",rules:[{conditions:l,execute:u}]};return e[oe.api].put("channels/set",{select:{feature:"thinkerbell/add-rule"},value:{ThinkerbellRule:{name,source:JSON.stringify(h)}}})})},e}(),ae=Object.freeze({api:Symbol("api"),settings:Symbol("settings"),listenForMessages:Symbol("listenForMessages")}),ce=function(e){function t(n,i){o(this,t);var r=a(this,e.call(this,["message"]));return r[ae.api]=n,r[ae.settings]=i,Object.seal(r),r}return s(t,e),t.prototype.subscribeToNotifications=function(){var e=this,t=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];if(!navigator.serviceWorker)return Promise.reject("No service worker supported");navigator.serviceWorker.addEventListener("message",this[ae.listenForMessages].bind(this));var n=this[ae.settings];return n.pushEndpoint&&n.pushPubKey&&n.pushAuth&&!t?Promise.resolve():navigator.serviceWorker.ready.then(function(e){return e.pushManager.subscribe({userVisibleOnly:!0})}).then(function(t){var i=t.endpoint,o=t.getKey?t.getKey("p256dh"):"",r=t.getKey?t.getKey("auth"):"";n.pushEndpoint=i,n.pushPubKey=btoa(String.fromCharCode.apply(null,new Uint8Array(o))),n.pushAuth=btoa(String.fromCharCode.apply(null,new Uint8Array(r)));var s=[[[{id:"setter:subscribe.webpush@link.mozilla.org"}],{Json:{subscriptions:[{public_key:n.pushPubKey,push_uri:n.pushEndpoint,auth:n.pushAuth}]}}]];return e[ae.api].put("channels/set",s)}).then(function(){var t=[[[{id:"setter:resource.webpush@link.mozilla.org"}],{Json:{resources:["res1"]}}]];return e[ae.api].put("channels/set",t)})["catch"](function(e){if("denied"===Notification.permission)throw new Error("Permission request was denied.");throw console.error("Error while saving subscription ",e),new Error(`Subscription error: ${e}`)})},t.prototype[ae.listenForMessages]=function(e){var t=e.data||{};t.action&&this.emit("message",t)},t}(V),le="unknown",ue=Object.freeze({api:Symbol("api"),id:Symbol("id"),manufacturer:Symbol("manufacturer"),model:Symbol("model"),name:Symbol("name"),watchers:Symbol("watchers"),tags:Symbol("tags"),channels:Symbol("channels"),getChannels:Symbol("getChannel"),getFetchChannel:Symbol("getFetchChannel"),getSendChannel:Symbol("getSendChannel")}),he=function(e){function t(n,i,r,s){o(this,t);var c=a(this,e.call(this,r));return c[ue.api]=i,c[ue.id]=n.id,c[ue.manufacturer]=n.properties&&n.properties.manufacturer||"",c[ue.model]=n.properties&&n.properties.model||"",c[ue.name]=n.properties&&n.properties.name||n.properties.product_name||"",c[ue.tags]=new Set(n.tags),c[ue.channels]=n.channels,c[ue.watchers]=s||new Map,c}return s(t,e),t.prototype.set=function(e){var t=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=this[ue.getSendChannel](e),i=n.supports_send.accepts,o=[{id:n.id},i?{[i.requires||i.optional]:t}:null];return this[ue.api].put("channels/set",[o])},t.prototype.get=function(e){var t=this[ue.getFetchChannel](e),n=t.supports_fetch.returns,i={id:t.id};return n&&"Binary"===(n.requires||n.optional)?this[ue.api].blob("channels/get",i):this[ue.api].put("channels/get",i).then(function(e){return e[t.id]})},t.prototype.watch=function(e,t){var n=this,i=this[ue.watchers].get(e);if(!i)throw new Error("Unsupported watcher `${alias}`!");var o=c(i,3),r=o[0],s=o[1],a=o[2],l=void 0===a?new Map:a;0===l.size&&i.push(l);var u=l.get(t);u||(u=function(e){return t(n[s](e))},l.set(t,u));var h=this[ue.getFetchChannel](r),d=h.id;this[ue.api].watch(d,u)},t.prototype.unwatch=function(e,t){var n=this[ue.watchers].get(e);if(!n)throw new Error("Unsupported watcher `${alias}`!");var i=c(n,3),o=i[0],r=i[2],s=r.get(t);r["delete"](t);var a=this[ue.getFetchChannel](o),l=a.id;this[ue.api].unwatch(l,s)},t.prototype.getTags=function(){return Array.from(this[ue.tags])},t.prototype.addTag=function(e){var t=this;if(!e||"string"!=typeof e)throw new Error("Tag should be valid non-empty string.");if(this[ue.tags].has(e))return Promise.resolve();this[ue.tags].add(e);var n={services:{id:this[ue.id]},tags:e},i={channels:{service:this[ue.id]},tags:e};return Promise.all([this[ue.api].post("services/tags",n),this[ue.api].post("channels/tags",i)])["catch"](function(n){throw t[ue.tags]["delete"](e),n})},t.prototype.removeTag=function(e){var t=this;if(!e||"string"!=typeof e)throw new Error("Tag should be valid non-empty string.");if(!this[ue.tags].has(e))return Promise.resolve();this[ue.tags]["delete"](e);var n={services:{id:this[ue.id]},tags:e},i={channels:{service:this[ue.id]},tags:e};return Promise.all([this[ue.api]["delete"]("services/tags",n),this[ue.api]["delete"]("channels/tags",i)])["catch"](function(n){throw t[ue.tags].add(e),n})},t.prototype.teardown=function(){for(var e of this[ue.watchers].values()){var t=c(e,3),n=t[0],i=t[2];if(i&&0!==i.size){var o=this[ue.getFetchChannel](n),r=o.id;for(var s of i.values())console.warn(`Forgotten watcher for ${r}!`),this[ue.api].unwatch(r,s);i.clear()}}},t.prototype[ue.getChannels]=function(e){var t=this;if(e.id){var n=this[ue.channels][e.id];return n?[n]:[]}if(e.feature||"string"==typeof e){var i=function(){var n=e.feature||e;return{v:Object.keys(t[ue.channels]).reduce(function(e,i){var o=t[ue.channels][i];return o.feature===n&&e.push(o),e},[])}}();if("object"==typeof i)return i.v}return[]},t.prototype[ue.getFetchChannel]=function(e){var t=this[ue.getChannels](e).find(function(e){return e.supports_fetch});if(!t)throw new Error(`Couldn't find channel that supports "fetch" with selector: ${e}`);return t},t.prototype[ue.getSendChannel]=function(e){var t=this[ue.getChannels](e).find(function(e){return e.supports_send});if(!t)throw new Error(`Couldn't find channel that supports "send" with selector: ${e}`);return t},r(t,[{key:"type",get:function(){return le}},{key:"id",get:function(){return this[ue.id]}},{key:"manufacturer",get:function(){return this[ue.manufacturer]}},{key:"model",get:function(){return this[ue.model]}},{key:"name",get:function(){return this[ue.name]}}]),t}(V),de="ip-camera",pe=function(e){function t(n,i){o(this,t);var r=a(this,e.call(this,n,i));return Object.seal(r),r}return s(t,e),t.prototype.getLatestImage=function(){return this.get("camera/x-latest-image")},t.prototype.takeSnapshot=function(){var e=this;return this.set("camera/store-snapshot").then(function(){return e.get("camera/x-latest-image")})},r(t,[{key:"type",get:function(){return de}}]),t}(he),fe="light",ve=function(e){function t(n,i){o(this,t);var r=a(this,e.call(this,n,i));return Object.seal(r),r}return s(t,e),t.prototype.isAvailable=function(){return this.get("device/available").then(function(e){return"On"===e.OnOff})},t.prototype.isOn=function(){return this.get("light/is-on").then(function(e){return"On"===e.OnOff})},t.prototype.turn=function(e){return this.set("light/is-on",e?"On":"Off")},r(t,[{key:"type",get:function(){return fe}}]),t}(he),ge="door-lock",me=function(e){function t(n,i){o(this,t);var r=a(this,e.call(this,n,i));return Object.seal(r),r}return s(t,e),t.prototype.isLocked=function(){return this.get("door/is-locked").then(function(e){if(!e)throw new Error("Door lock status is not available yet!");return"Locked"===e.DoorLocked})},t.prototype.lockUnlock=function(e){return this.set("door/is-locked",e?"Locked":"Unlocked")},r(t,[{key:"type",get:function(){return ge}}]),t}(he),be="motion-sensor",ye=Object.freeze({onMotionStateChanged:Symbol("onMotionStateChanged")}),Se=function(e){return!!e&&"Open"===e.OpenClosed},ke=function(e){function t(n,i){o(this,t);var r=a(this,e.call(this,n,i,void 0,new Map([["motion",["door/is-open",ye.onMotionStateChanged]]])));return Object.freeze(r),r}return s(t,e),t.prototype.isMotionDetected=function(){return this.get("door/is-open").then(Se)},t.prototype[ye.onMotionStateChanged]=function(e){return Se(e)},r(t,[{key:"type",get:function(){return be}}]),t}(he),we=Object.freeze({api:Symbol("api"),settings:Symbol("settings"),db:Symbol("db"),cache:Symbol("services"),pollingTimer:Symbol("pollingTimer"),getServiceInstance:Symbol("getServiceInstance"),hasChannelWithFeature:Symbol("hasChannelWithFeature"),getCache:Symbol("getCache")}),xe=function(e,t){var n=Object.keys(e),i=Object.keys(t);return n.length===i.length&&!n.some(function(n){var i=e[n],o=t[n],r=typeof i;return r!==typeof o||("object"!==r||null===i||null===o?i!==o:Array.isArray(i)?i.length!==o.length||i.some(function(e,t){return e!==o[t]}):!xe(i,o))})},_e=function(e){function t(n,i,r){o(this,t);var s=a(this,e.call(this,["services-changed","service-changed"]));return s[we.db]=n,s[we.api]=i,s[we.settings]=r,s[we.cache]=null,s[we.pollingTimer]=new X(s[we.settings].servicePollingInterval),Object.seal(s),s}return s(t,e),t.prototype.getAll=function(){return this[we.getCache]().then(function(e){return Array.from(e.values())})},t.prototype.get=function(e){return this[we.getCache]().then(function(t){return t.get(e)})},t.prototype.togglePolling=function(e){e!==this[we.pollingTimer].started&&(e?this[we.pollingTimer].start(this.sync.bind(this)):this[we.pollingTimer].stop())},t.prototype.sync=function(){var e=this;return Promise.all([this[we.api].get("services"),this[we.db].getServices(),this[we.getCache]()]).then(function(t){var n=c(t,3),i=n[0],o=n[1],r=n[2],s=0;i.forEach(function(t){var n=o.find(function(e){return e.id===t.id}),i=!!n;if(!i||!xe(t,n)){e[we.db].setService(t);var a=e[we.getServiceInstance](t);r.set(a.id,a),i?e.emit("service-changed",a):s++}});var a=o.length+s-i.length;a>0&&o.forEach(function(t){var n=i.find(function(e){return e.id===t.id});if(!n){e[we.db].deleteService(t);var o=r.get(t.id);o.teardown(),r["delete"](o.id)}}),(s>0||a>0)&&e.emit("services-changed")})},t.prototype[we.getCache]=function(){var e=this;return this[we.cache]?this[we.cache]:this[we.cache]=this[we.db].getServices()["catch"](function(e){return console.error("Could not load services from the local DB: %o",e),[]}).then(function(t){var n=new Map;return t.forEach(function(t){n.set(t.id,e[we.getServiceInstance](t))}),n})},t.prototype[we.getServiceInstance]=function(e){switch(e.adapter){case"ip-camera@link.mozilla.org":return new pe(e,this[we.api]);case"philips_hue@link.mozilla.org":return new ve(e,this[we.api]);case"OpenZwave Adapter":return this[we.hasChannelWithFeature](e.channels,"door/is-locked")?new me(e,this[we.api]):this[we.hasChannelWithFeature](e.channels,"door/is-open")?new ke(e,this[we.api]):new he(e,this[we.api]);default:return new he(e,this[we.api])}},t.prototype[we.hasChannelWithFeature]=function(e,t){return Object.keys(e).some(function(n){return e[n].feature===t})},t}(V),Oe=Object.freeze({settings:Symbol("settings"),net:Symbol("net"),watchTimer:Symbol("watchTimer"),watchEventBus:Symbol("watchEventBus"),watchGetters:Symbol("watchGetters"),getURL:Symbol("getURL"),onceOnline:Symbol("onceOnline"),onceAuthenticated:Symbol("onceAuthenticated"),onceDocumentVisible:Symbol("onceDocumentVisible"),onceReady:Symbol("onceReady"),fetchGetterValues:Symbol("fetchGetterValues"),updateGetterValue:Symbol("updateGetterValue")}),Le=function(){function e(t,n){o(this,e),this[Oe.net]=t,this[Oe.settings]=n,this[Oe.watchTimer]=new X(this[Oe.settings].watchInterval),this[Oe.watchEventBus]=new V,this[Oe.watchGetters]=new Map,this[Oe.fetchGetterValues]=this[Oe.fetchGetterValues].bind(this),Object.freeze(this)}return e.prototype.get=function(e){var t=this;return this[Oe.onceReady]().then(function(){return t[Oe.net].fetchJSON(t[Oe.getURL](e))})},e.prototype.post=function(e,t){var n=this;return this[Oe.onceReady]().then(function(){return n[Oe.net].fetchJSON(n[Oe.getURL](e),"POST",t)})},e.prototype.put=function(e,t){var n=this;return this[Oe.onceReady]().then(function(){return n[Oe.net].fetchJSON(n[Oe.getURL](e),"PUT",t)})},e.prototype["delete"]=function(e,t){var n=this;return this[Oe.onceReady]().then(function(){return n[Oe.net].fetchJSON(n[Oe.getURL](e),"DELETE",t)})},e.prototype.blob=function(e,t){var n=this,i=arguments.length<=2||void 0===arguments[2]?"image/jpeg":arguments[2];return this[Oe.onceReady]().then(function(){return t?n[Oe.net].fetchBlob(n[Oe.getURL](e),i,"PUT",t):n[Oe.net].fetchBlob(n[Oe.getURL](e),i)})},e.prototype.watch=function(e,t){this[Oe.watchEventBus].on(e,t),this[Oe.watchGetters].has(e)||(this[Oe.watchGetters].set(e,{id:e,value:null}),this[Oe.watchTimer].started||this[Oe.watchTimer].start(this[Oe.fetchGetterValues]))},e.prototype.unwatch=function(e,t){return this[Oe.watchGetters].has(e)?(this[Oe.watchEventBus].off(e,t),this[Oe.watchEventBus].hasListeners(e)||this[Oe.watchGetters]["delete"](e),void(0===this[Oe.watchGetters].size&&this[Oe.watchTimer].stop())):void console.warn('Getter with id "%s" is not watched.',e)},e.prototype[Oe.getURL]=function(e){if(!e||"string"!=typeof e)throw new Error("Path should be valid non-empty string.");return`${this[Oe.net].origin}/api/v${this[Oe.settings].apiVersion}/${e}`},e.prototype[Oe.onceReady]=function(){return Promise.all([this[Oe.onceOnline](),this[Oe.onceAuthenticated](),this[Oe.onceDocumentVisible]()])},e.prototype[Oe.onceOnline]=function(){var e=this[Oe.net];return e.online?Promise.resolve():new Promise(function(t){return e.once("online",function(){return t()})})},e.prototype[Oe.onceAuthenticated]=function(){
var e=this[Oe.settings];return e.session?Promise.resolve():new Promise(function(t){return e.once("session",function(){return t()})})},e.prototype[Oe.onceDocumentVisible]=function(){return document.hidden?new Promise(function(e){document.addEventListener("visibilitychange",function t(){document.hidden||(document.removeEventListener("visibilitychange",t),e())})}):Promise.resolve()},e.prototype[Oe.fetchGetterValues]=function(){var e=this;if(0===this[Oe.watchGetters].size)return Promise.resolve();var t=Array.from(this[Oe.watchGetters].values()).map(function(e){var t=e.id;return{id:t}});return this.put("channels/get",t).then(function(t){Object.keys(t).forEach(function(n){var i=e[Oe.watchGetters].get(n);i&&e[Oe.updateGetterValue](i,t[n])})})},e.prototype[Oe.updateGetterValue]=function(e,t){var n=!1;if(t&&e.value){var i=Object.keys(t),o=c(i,1),r=o[0];if("Error"===r)return void console.error("Failed to retrieve value for getter (%s): %o",e.id,t[r]);var s=t[r],a=e.value[r];n=s&&a&&"object"==typeof s?JSON.stringify(s)!==JSON.stringify(a):s!==a}else n=t!==e.value;n&&(e.value=Object.freeze(t),this[Oe.watchEventBus].emit(e.id,e.value))},e}(),Ne=Object.freeze({settings:Symbol("settings"),db:Symbol("db"),net:Symbol("net"),boxes:Symbol("boxes"),webPush:Symbol("webPush"),api:Symbol("api")}),Ce=function(e){function t(){var n=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],i=n.settings,r=n.db,s=n.net;o(this,t);var c=a(this,e.call(this));return c[Ne.settings]=i||new W,c[Ne.db]=r||new Z,c[Ne.net]=s||new ie(c[Ne.settings]),c[Ne.boxes]=Object.freeze([]),c[Ne.api]=new Le(c[Ne.net],c[Ne.settings]),c[Ne.webPush]=new ce(c[Ne.api],c[Ne.settings]),c.services=new _e(c[Ne.db],c[Ne.api],c[Ne.settings]),c.recipes=new se(c[Ne.api]),Object.seal(c),c}return s(t,e),t.prototype.init=function(){var e=this;return window.foxbox=this,this[Ne.net].on("online",function(t){e._dispatchEvent("online",t)}),this[Ne.webPush].on("message",function(t){e._dispatchEvent("push-message",t)}),this._initDiscovery().then(function(){return e[Ne.net].init()}),this._initUserSession().then(function(){return e[Ne.db].init()})},t.prototype.clear=function(e){var t=[this[Ne.settings].clear(),this[Ne.db].clear()];return navigator.serviceWorker?(e||t.push(navigator.serviceWorker.ready.then(function(e){return e.unregister()})),Promise.all(t)):Promise.all(t)},t.prototype._initDiscovery=function(){var e=this;return this[Ne.settings].skipDiscovery?Promise.resolve():this[Ne.net].fetchJSON(this[Ne.settings].registrationService).then(function(t){if(!Array.isArray(t))return void console.warn("Got unexpected response from registry server",t);var n=Math.floor(Date.now()/1e3)-120;if(e[Ne.boxes]=Object.freeze(t.filter(function(e){return e.timestamp-n>=0}).map(function(e){var t=JSON.parse(e.message),n=t.local_origin,i=t.tunnel_origin,o=e.client;return Object.freeze({local_origin:n,tunnel_origin:i,client:o})})),e._dispatchEvent("discovery"),!e[Ne.boxes].length&&!e[Ne.settings].localOrigin&&!e[Ne.settings].tunnelOrigin)throw new Error("Registration service did not return any boxes.");e[Ne.settings].configured||1!==e[Ne.boxes].length||e.selectBox()})["catch"](function(t){if(!e[Ne.settings].localOrigin&&!e[Ne.settings].tunnelOrigin)return console.warn("Retrying box discovery... Reason is %o",t),new Promise(function(t){setTimeout(function(){e._initDiscovery().then(t,t)},1e3)})})},t.prototype.selectBox=function(){var e=arguments.length<=0||void 0===arguments[0]?0:arguments[0];if(!this[Ne.boxes].length)return this[Ne.settings].configured=!1,void console.error("No boxes found. Is this app online? Is the box online?");if(e>=this[Ne.boxes].length)return this[Ne.settings].configured=!1,void console.error("Index out of range.");var t=this[Ne.boxes][e];this[Ne.settings].localOrigin=t.local_origin,t.tunnel_origin?this[Ne.settings].tunnelOrigin=t.tunnel_origin:this[Ne.settings].tunnelOrigin="",this[Ne.settings].client=t.client,this[Ne.settings].configured=!0},t.prototype._initUserSession=function(){if(this.isLoggedIn)return Promise.resolve();var e=new URL(location.href),t=new URLSearchParams(e.search.substring(1));return t.has("session_token")?(this[Ne.settings].session=t.get("session_token").replace(/ /g,"+"),t["delete"]("session_token"),e.search=t,location.replace(e.href),Promise.reject()):Promise.resolve()},t.prototype.login=function(){if(!this.isLoggedIn){var e=encodeURIComponent(location);location.replace(`${this[Ne.net].origin}/?redirect_url=${e}`)}},t.prototype.logout=function(){this[Ne.settings].session=null},t.prototype.subscribeToNotifications=function(){var e=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];return this[Ne.webPush].subscribeToNotifications(e)},r(t,[{key:"online",get:function(){return this[Ne.net].online}},{key:"client",get:function(){return this[Ne.settings].client}},{key:"boxes",get:function(){return this[Ne.boxes]}},{key:"isLoggedIn",get:function(){return!!this[Ne.settings].session}}]),t}(e.Service),Ee=function(e){function t(){o(this,t);var n=new Ce,i=document.querySelector(".app-view-container"),r={foxbox:n,mountNode:i},s=new f(r),c=new I(r),l=a(this,e.call(this,{"":s,"users/(.+)":s,services:new b(r),"services/(.+)/tags":new L(r),"services/(.+)":new x(r),themes:c,"themes/(.+)":c,"dev/(.+)/(.+)":new P(r)}));return l.foxbox=n,l}return s(t,e),t.prototype.main=function(){var e=this;this.foxbox.init().then(function(){e.foxbox.isLoggedIn?(e.foxbox.subscribeToNotifications(),e.foxbox.services.sync(),""===location.hash&&(location.hash="#services"),e.foxbox.addEventListener("push-message",function(e){e.action&&(location.hash=e.action)})):location.hash="#users/login",e.route()})},t}(e.RoutingController),Ie=new Ee;Ie.main()});
//# sourceMappingURL=app.js.map
